# v20.0 PRD：战斗节奏与智能难度系统

> 代号：**Flow Guardian**（心流守护者）
> 核心理念：让每个孩子都能找到属于自己的"心流区"

---

## 一、问题诊断

### 1.1 当前计时参数

| 难度 | 答题时限 | 危险区 | 速度S级 | 速度A级 | 速度B级 |
|------|---------|--------|---------|---------|---------|
| Easy | 5秒 | 最后1秒 | ≤1.5秒 | ≤3秒 | ≤4.5秒 |
| Normal | 3秒 | 最后0.8秒 | ≤1.2秒 | ≤2秒 | ≤2.8秒 |
| Hard | 2秒 | 最后0.5秒 | ≤0.8秒 | ≤1.3秒 | ≤1.8秒 |

### 1.2 研究数据对比

| 指标 | 数值 | 来源 |
|------|------|------|
| 口算自动化（口头回答） | ~1秒 | 认知心理学研究 |
| 口算流利度（键盘输入） | ~3秒 | XtraMath / Rocket Math |
| 英国MTC国家测试（8-9岁） | **6秒/题** | UK Gov Education Statistics |
| XtraMath宽松模式 | 6秒 | XtraMath |
| XtraMath早期学习者 | **12秒** | XtraMath |
| 二年级末（书写） | 3秒/题 (20题/分) | Rocket Math |
| 三年级末（书写） | 2秒/题 (30题/分) | Rocket Math |
| 四年级末（书写） | 1.5秒/题 (40题/分) | Rocket Math |

### 1.3 核心问题

1. **Normal模式3秒太紧**：英国国家标准给8-9岁孩子6秒，我们的Normal只给3秒，对7-9岁孩子造成焦虑而非挑战
2. **Hard模式2秒极端**：即使成年人在多位数乘法或分数题上也很难2秒内完成，S级0.8秒几乎不可能达到
3. **无动态调节**：选定难度后完全固定，不能根据孩子表现实时调整
4. **动画间隔累积**：答对后等待时间可达3-4秒（英雄攻击+怪物反应+下一题），流畅感断裂
5. **失败惩罚循环过长**：答错后约3.3秒非交互时间（反馈1s + 蓄力0.5s + 攻击0.5s + 闪屏0.3s + 等待1s）

---

## 二、设计灵感来源

### 2.1 生化危机4：隐藏Rank系统（核心参考）

RE4的动态难度是游戏史上最优雅的DDA实现：
- **隐藏的1-10级Rank值**，玩家完全不知道它的存在
- 表现好 → Rank上升 → 敌人更多、更强、更快
- 表现差 → Rank下降 → 敌人减少、变弱、变慢
- **关键设计**：难度选择设上限/下限（Easy的Rank永远不超过5）
- **速通玩家的发现**：有人故意浪费子弹来降低Rank，让某些区域更快通过

**应用**：隐藏的"气势值"系统，根据连续答对/错动态调整答题时间和怪物行为

### 2.2 马里奥赛车：橡皮筋机制

- 落后时给更强的道具，领先时给更弱的道具
- 核心原则：**让玩家永远有翻盘的可能**
- 三层机制：速度调节 + 道具分配 + 行为改变

**应用**：血量低时给更多加血机会；连续答错时适当延长答题时间

### 2.3 Hades：Heat系统（可选难度修改器）

- 通关后可以选择性增加难度修改器
- 每个修改器独立，玩家自己决定哪些方面更难
- 死后给2%累积伤害减免（God Mode）—— 越失败越强

**应用**：让孩子选择挑战方向（更短时间 vs 更难题目 vs 更强怪物）

### 2.4 节奏游戏：分级判定窗口

| DDR判定 | 窗口 | 类比 |
|---------|------|------|
| Marvelous | ±16.7ms | — |
| Perfect | ±33ms | 速度S级 |
| Great | ±92ms | 速度A级 |
| Good | ±142ms | 速度B级 |
| Miss | ±225ms | 速度C级 |

**应用**：保持S/A/B/C分级，但根据题目类型和孩子表现动态调整阈值

### 2.5 Celeste："郊狼时间"（Coyote Time）

- 走出平台边缘后仍有100-150ms可以跳跃
- 在快要落地前按跳会被记忆，落地瞬间自动执行
- **核心理念**：弥合玩家意图和系统输入之间的差距

**应用**：答题时限到0时，如果500ms内提交答案仍然有效（"郊狼时间"）

### 2.6 心流理论（Csikszentmihalyi）

```
焦虑区
  ↑   ╭──────────╮
难度 │  │ 心流通道 │  ← 最佳学习区
  │   ╰──────────╯
  ↓
无聊区
  ──────────────→
      技能水平
```

- 难度必须随技能同步上升
- 太难 → 焦虑 → 放弃
- 太简单 → 无聊 → 放弃
- **阶梯式曲线**：关卡内逐步上升，关卡间略微回落

---

## 三、核心设计方案

### 3.1 答题时限重新校准

基于英国MTC标准（6秒/8-9岁）和认知研究数据：

#### 基础时限（静态，选难度时确定）

| 难度 | 新时限 | 旧时限 | 变化 | 依据 |
|------|--------|--------|------|------|
| Easy | **8秒** | 5秒 | +3秒 | 高于MTC标准，适合7-8岁初学者 |
| Normal | **5秒** | 3秒 | +2秒 | 略低于MTC标准，适合9-10岁 |
| Hard | **3.5秒** | 2秒 | +1.5秒 | 挑战性但可达到，适合11-12岁 |

#### 题目类型修正（在基础时限上乘以系数）

| 题目类型 | 时间系数 | 理由 |
|----------|---------|------|
| 小九九(1-9) | ×1.0 | 基准 |
| 大九九(10-20) | ×1.3 | 更大数字需要更多处理时间 |
| 乘法速算 | ×1.2 | 需要技巧应用 |
| 分数/小数 | ×1.4 | 概念更复杂 |
| 单位换算 | ×1.3 | 需要记忆进率 |

例：Normal难度 + 分数题 = 5秒 × 1.4 = **7秒**

#### 危险区调整

| 难度 | 新危险区 | 旧危险区 |
|------|---------|---------|
| Easy | 最后2秒 | 最后1秒 |
| Normal | 最后1.5秒 | 最后0.8秒 |
| Hard | 最后1秒 | 最后0.5秒 |

### 3.2 郊狼时间（Coyote Grace Period）

当倒计时归零时，不立即判超时，而是进入一个隐藏的宽限期：

```javascript
// 倒计时到0后的隐藏宽限
var coyoteTime = {
    easy: 800,    // 800ms宽限
    normal: 500,  // 500ms宽限
    hard: 300     // 300ms宽限
};
```

- 宽限期内提交的答案**仍然有效**，但速度评级自动降为C级
- 宽限期内倒计时条已经消失，视觉上看起来是"超时了"
- 如果在宽限期内答对，显示"千钧一发！"特效（不显示具体机制）
- **目的**：让"差一点就答上了"的孩子不会感到挫败

### 3.3 隐藏Rank系统（RE4 灵感）

#### 气势值（Momentum）

引入隐藏的"气势值"（0-100），影响战斗节奏：

```javascript
var MomentumSystem = {
    value: 50,          // 初始气势值
    min: 0,
    max: 100,

    // 答对时
    onCorrect: function(speedRank, combo) {
        var gain = { S: 8, A: 5, B: 3, C: 1 }[speedRank];
        if (combo >= 5) gain *= 1.5;
        this.value = Math.min(100, this.value + gain);
    },

    // 答错时
    onWrong: function() {
        this.value = Math.max(0, this.value - 12);
    },

    // 超时时
    onTimeout: function() {
        this.value = Math.max(0, this.value - 8);
    }
};
```

#### 气势值影响

| 气势区间 | 名称 | 答题时限调整 | 怪物行为 | 附加效果 |
|---------|------|-------------|---------|---------|
| 0-20 | 低谷 | +30%时间 | 怪物偶尔"犹豫"不攻击 | 加血概率提升 |
| 21-40 | 恢复 | +15%时间 | 正常 | 无 |
| 41-60 | 稳定 | 基准时间 | 正常 | 无 |
| 61-80 | 高涨 | 基准时间 | 怪物可能使用特殊行为 | 暴击概率提升 |
| 81-100 | 巅峰 | -10%时间 | 怪物全力战斗 | 伤害加成+掉落提升 |

**关键原则**：
- 气势值对玩家**完全不可见**（RE4原则）
- 低谷区给更多时间，让孩子有机会回到心流
- 巅峰区略微收紧时间，保持挑战感
- 调整幅度小（±10%~30%），不让玩家感知到系统在"放水"

#### 难度帽（Difficulty Caps）

| 选择难度 | 气势值下限 | 气势值上限 | 效果 |
|---------|-----------|-----------|------|
| Easy | 20 | 80 | 不会太惨，也不会太激烈 |
| Normal | 10 | 90 | 较宽泛的体验 |
| Hard | 0 | 100 | 完整的动态范围 |

### 3.4 速度评级窗口重新校准

| 评级 | Easy | Normal | Hard | 旧Easy | 旧Normal | 旧Hard |
|------|------|--------|------|--------|---------|--------|
| S | ≤2.0秒 | ≤1.5秒 | ≤1.0秒 | ≤1.5秒 | ≤1.2秒 | ≤0.8秒 |
| A | ≤4.0秒 | ≤3.0秒 | ≤2.0秒 | ≤3.0秒 | ≤2.0秒 | ≤1.3秒 |
| B | ≤6.0秒 | ≤4.5秒 | ≤3.0秒 | ≤4.5秒 | ≤2.8秒 | ≤1.8秒 |
| C | >6.0秒 | >4.5秒 | >3.0秒 | >4.5秒 | >2.8秒 | >1.8秒 |

伤害倍率保持不变：S=1.5x, A=1.2x, B=1.0x, C=0.8x

### 3.5 动画节奏优化

#### 答对后的节奏（当前 → 优化后）

```
当前流程（总计 ~2.5-4秒非交互）：
  英雄攻击动画(600-1500ms) → 伤害结算 → 怪物行为(0-1500ms) → 下一题(800ms)

优化后流程（总计 ~1.2-2秒非交互）：
  英雄攻击(400-800ms) → 伤害结算+下一题同时准备 → 下一题(400ms)
```

具体改动：

| 环节 | 当前 | 优化后 | 说明 |
|------|------|--------|------|
| 普通攻击动画 | 650ms | **400ms** | 压缩非关键帧 |
| 双重攻击 | 1000ms | **700ms** | 减少间隔 |
| 三连攻击 | 850ms | **600ms** | 更紧凑 |
| 蓄力攻击 | 1100ms | **800ms** | 蓄力阶段压缩 |
| 必杀攻击 | 1500ms | **1200ms** | 保持史诗感但更紧凑 |
| 正常流下一题延迟 | 800ms | **400ms** | 快速过渡 |
| 怪物行为后下一题 | 400ms | **300ms** | 略微加快 |

#### 答错后的节奏（当前 → 优化后）

```
当前流程（总计 ~3.3秒非交互）：
  反馈(1000ms) → 怪物蓄力(500ms) → 攻击(500ms) → 闪屏(300ms) → 等待(1000ms)

优化后流程（总计 ~2秒非交互）：
  反馈+蓄力并行(600ms) → 攻击(400ms) → 闪屏(200ms) → 等待(600ms)
```

| 环节 | 当前 | 优化后 | 说明 |
|------|------|--------|------|
| 错误反馈 | 1000ms | **600ms**（与蓄力并行） | 反馈和蓄力同时发生 |
| 怪物蓄力 | 500ms | **与反馈并行** | 不再单独等待 |
| 怪物攻击动画 | 500ms | **400ms** | 略微加快 |
| 屏幕闪烁 | 300ms | **200ms** | 更快速的打击感 |
| 受击后等待 | 1000ms | **600ms** | 快速回到题目 |

#### 关卡过渡优化

| 环节 | 当前 | 优化后 |
|------|------|--------|
| 怪物死亡 → 过渡开始 | 1200ms | **800ms** |
| 过渡遮罩显示 | 1500ms | **1000ms** |
| 新怪物入场 | 1800ms | **1200ms** |
| 入场台词显示 | 1200ms | **800ms** |

### 3.6 练习模式计时器优化

| 难度 | 当前 | 优化后 | 依据 |
|------|------|--------|------|
| Easy | 15秒 | **12秒** | 充裕但不过于宽松 |
| Normal | 10秒 | **8秒** | 接近MTC标准 |
| Hard | 7秒 | **5秒** | 有挑战性 |

### 3.7 失败保护机制

#### 连续答错保护（Hades God Mode 灵感）

```javascript
// 连续答错3次后，激活"守护之光"
if (battle.consecutiveWrong >= 3) {
    // 下一题时限额外 +2秒
    // 怪物攻击伤害减半（这一次不扣HP）
    // 显示鼓励语："别放弃，再试一次！"
    // 效果在答对后消失
    battle.guardianLight = true;
}
```

#### 血量极低保护

```javascript
// HP=1时，怪物攻击有25%概率"失手"
if (battle.playerHP === 1) {
    var missChance = 0.25; // 怪物失手概率
    // 显示："怪物的攻击被你的勇气弹开了！"
}
```

#### 超时重做机制

```javascript
// 超时的题目不直接判错，而是给一次"再来"的机会（仅Easy/Normal）
if (isTimeout && App.difficulty !== 'hard') {
    // 第一次超时：显示"时间到！再想想？"，重新给一半时间
    // 第二次超时：正常判错
    if (!battle.retried) {
        battle.retried = true;
        battle.timeLimit = baseTime * 0.5;
        showBattleQuestion(); // 重新显示同一题
        return; // 不进入错误流程
    }
}
```

---

## 四、技术实现方案

### 4.1 新增文件

| 文件 | 内容 | 行数估计 |
|------|------|---------|
| `js/momentum-system.js` | 气势值系统（隐藏DDA） | ~150行 |

### 4.2 修改文件

| 文件 | 改动范围 | 说明 |
|------|---------|------|
| `js/battle-combat.js` | **大改** | 答题时限、郊狼时间、气势值接入、动画节奏、失败保护 |
| `js/move-system.js` | **中改** | 速度评级阈值重新校准 |
| `js/hero-system.js` | **中改** | 攻击动画时长压缩 |
| `js/battle-arena.js` | **中改** | 过渡动画时长压缩、攻击动画压缩 |
| `js/monster-behavior.js` | **小改** | 行为动画时长压缩 |
| `js/behavior-v2.js` | **小改** | 行为动画时长压缩 |
| `js/combo-engine.js` | **小改** | 连击中断动画压缩 |
| `js/practice.js` | **小改** | 练习模式时限更新 |
| `css/style.css` | **中改** | CSS动画时长同步更新 |
| `index.html` | **小改** | 新增script标签 |

### 4.3 momentum-system.js 详细设计

```javascript
/**
 * momentum-system.js — 隐藏动态难度调整系统
 * 灵感来源：Resident Evil 4 的隐藏Rank系统
 *
 * 核心原则：
 * 1. 玩家永远不知道这个系统的存在
 * 2. 调整幅度微妙，不让玩家感觉被"放水"
 * 3. 目标是让每个孩子都停留在"心流通道"内
 */

var MomentumSystem = {

    value: 50,           // 气势值 0-100
    floor: 10,           // 下限（根据难度设置）
    ceiling: 90,         // 上限（根据难度设置）
    smoothWindow: [],    // 最近10题的表现滑动窗口

    // 初始化
    init: function(difficulty) {
        this.value = 50;
        this.smoothWindow = [];
        var caps = {
            easy:   { floor: 20, ceiling: 80 },
            normal: { floor: 10, ceiling: 90 },
            hard:   { floor: 0,  ceiling: 100 }
        };
        var cap = caps[difficulty] || caps.normal;
        this.floor = cap.floor;
        this.ceiling = cap.ceiling;
    },

    // 答对
    onCorrect: function(speedRank, combo) {
        var gain = { S: 8, A: 5, B: 3, C: 1 }[speedRank] || 3;
        if (combo >= 10) gain *= 2;
        else if (combo >= 5) gain *= 1.5;
        this.value = Math.min(this.ceiling, this.value + gain);
        this.smoothWindow.push(1);
        if (this.smoothWindow.length > 10) this.smoothWindow.shift();
    },

    // 答错
    onWrong: function() {
        this.value = Math.max(this.floor, this.value - 12);
        this.smoothWindow.push(0);
        if (this.smoothWindow.length > 10) this.smoothWindow.shift();
    },

    // 超时
    onTimeout: function() {
        this.value = Math.max(this.floor, this.value - 8);
        this.smoothWindow.push(0);
        if (this.smoothWindow.length > 10) this.smoothWindow.shift();
    },

    // 获取时间调整系数
    getTimeMultiplier: function() {
        if (this.value <= 20) return 1.30;       // 低谷：+30%时间
        if (this.value <= 40) return 1.15;       // 恢复：+15%时间
        if (this.value <= 60) return 1.00;       // 稳定：基准
        if (this.value <= 80) return 1.00;       // 高涨：基准
        return 0.90;                              // 巅峰：-10%时间
    },

    // 获取当前气势区间名称（内部用）
    getZone: function() {
        if (this.value <= 20) return 'low';
        if (this.value <= 40) return 'recovery';
        if (this.value <= 60) return 'stable';
        if (this.value <= 80) return 'high';
        return 'peak';
    },

    // 最近正确率
    getRecentAccuracy: function() {
        if (this.smoothWindow.length === 0) return 0.5;
        var sum = 0;
        for (var i = 0; i < this.smoothWindow.length; i++) {
            sum += this.smoothWindow[i];
        }
        return sum / this.smoothWindow.length;
    },

    // 怪物是否应该"失手"（低谷保护）
    shouldMonsterMiss: function() {
        if (this.value > 20) return false;
        return Math.random() < 0.25;
    },

    // 是否触发守护之光（连续答错保护）
    shouldActivateGuardian: function(consecutiveWrong) {
        return consecutiveWrong >= 3 && this.value <= 30;
    }
};
```

### 4.4 battle-combat.js 关键改动

#### 4.4a 答题时限计算

```javascript
// 替换现有的固定时限
BattleMode.calculateTimeLimit = function() {
    // 基础时限
    var baseTimes = { easy: 8000, normal: 5000, hard: 3500 };
    var baseTime = baseTimes[App.difficulty] || 5000;

    // 题目类型系数
    var moduleMultipliers = {
        xiaojiujiu: 1.0,
        times: 1.3,
        multiply: 1.2,
        fraction: 1.4,
        decimal: 1.4,
        unit: 1.3
    };
    var moduleKey = battle.module || App.currentModule || 'xiaojiujiu';
    var moduleMult = moduleMultipliers[moduleKey] || 1.0;

    // 气势值系数（隐藏DDA）
    var momentumMult = MomentumSystem.getTimeMultiplier();

    return Math.round(baseTime * moduleMult * momentumMult);
};
```

#### 4.4b 郊狼时间

```javascript
// 在 startBattleTimer() 中，倒计时到0时
BattleMode.handleTimerExpiry = function() {
    var coyoteTimes = { easy: 800, normal: 500, hard: 300 };
    var coyoteTime = coyoteTimes[App.difficulty] || 500;

    battle.inCoyoteTime = true;
    battle.coyoteTimer = setTimeout(function() {
        battle.inCoyoteTime = false;
        // 真正的超时处理
        BattleMode.handleTimeoutAnswer();
    }, coyoteTime);
};

// 在 checkAnswer() 中
BattleMode.checkAnswer = function(answer) {
    // 如果在郊狼时间内答对
    if (battle.inCoyoteTime && battle.coyoteTimer) {
        clearTimeout(battle.coyoteTimer);
        battle.inCoyoteTime = false;
        // 有效但速度评级自动降为C
        battle.forcedRankC = true;
        showBattleText('千钧一发！', '#ff9800');
    }
    // ... 正常检查逻辑 ...
};
```

#### 4.4c 失败保护

```javascript
// 在 handleWrongAnswer() 末尾
BattleMode.checkGuardianLight = function() {
    if (MomentumSystem.shouldActivateGuardian(battle.consecutiveWrong)) {
        battle.guardianLight = true;
        // 下一题额外+2秒
        // 显示温暖的鼓励
        var messages = [
            '别灰心，再来一次！',
            '你可以的，慢慢想！',
            '深呼吸，仔细看题！',
            '错误是学习的阶梯！'
        ];
        var msg = messages[Math.floor(Math.random() * messages.length)];
        BattleMode.showSpeechBubble('hero', msg, 1500);
    }
};

// 守护之光生效时
BattleMode.applyGuardianLight = function(baseTime) {
    if (battle.guardianLight) {
        baseTime += 2000; // +2秒
        // 答对后取消守护之光
    }
    return baseTime;
};
```

#### 4.4d 超时重做（Easy/Normal）

```javascript
BattleMode.handleTimeoutAnswer = function() {
    if (App.difficulty !== 'hard' && !battle.retried) {
        // 第一次超时：给一次重做机会
        battle.retried = true;
        showBattleText('再想想！', '#ff9800');

        // 用一半时间重新开始计时
        var retryTime = BattleMode.calculateTimeLimit() * 0.6;
        battle.timeLimit = retryTime;
        BattleMode.startBattleTimer();
        return; // 不进入错误流程
    }

    // 第二次超时或Hard模式：正常判错
    battle.retried = false;
    MomentumSystem.onTimeout();
    // ... 原有超时处理逻辑 ...
};
```

### 4.5 动画时长修改一览

#### hero-system.js

| 函数 | 变量 | 当前 | 新值 |
|------|------|------|------|
| attackNormal | 举手 | 150ms | **100ms** |
| attackNormal | 武器飞行 | 300ms | **200ms** |
| attackNormal | 命中闪烁 | 200ms | **100ms** |
| attackDouble | 冲刺 | 150ms | **100ms** |
| attackDouble | 武器1飞行 | 200ms | **150ms** |
| attackDouble | 武器2飞行 | 150ms | **100ms** |
| attackDouble | 返回 | 150ms | **100ms** |
| attackTriple | 传送 | 100ms | **80ms** |
| attackTriple | 斩击×3 | 100ms×3 | **70ms×3** |
| attackTriple | 蓄力终结 | 150ms | **100ms** |
| attackCharged | 屏幕变暗 | 100ms | **80ms** |
| attackCharged | 蓄力 | 300ms | **200ms** |
| attackCharged | 巨型武器飞行 | 300ms | **250ms** |
| attackCharged | 爆炸 | 300ms | **200ms** |
| attackUltimate | 白屏 | 100ms | **80ms** |
| attackUltimate | 飞到中央 | 200ms | **150ms** |
| attackUltimate | 技能名 | 300ms | **250ms** |
| attackUltimate | 彩虹光束 | 400ms | **350ms** |
| attackUltimate | 爆炸 | 300ms | **250ms** |

#### battle-arena.js

| 函数 | 变量 | 当前 | 新值 |
|------|------|------|------|
| heroAttackAnimation | 举起 | 200ms | **150ms** |
| heroAttackAnimation | 挥击 | 400ms | **300ms** |
| heroHitAnimation | 受击反应 | 400ms | **300ms** |
| enemyEnterAnimation | 入场滑入 | 50ms | **50ms**（不变） |
| enemyEnterAnimation | 台词出现 | 500ms | **400ms** |
| enemyEnterAnimation | 台词持续 | 1200ms | **800ms** |
| enemyEnterAnimation | 总入场 | 1800ms | **1200ms** |
| enemyHitAnimation | 命中闪烁 | 400ms | **300ms** |
| enemyAttackAnimation | 投射飞行 | 600ms | **400ms** |
| enemyAttackAnimation | 回归idle | 500ms | **350ms** |

#### battle-combat.js

| 位置 | 变量 | 当前 | 新值 |
|------|------|------|------|
| initStage | 入场前延迟 | 1500ms | **1000ms** |
| showStageTransition | 过渡遮罩 | 1500ms | **1000ms** |
| handleCorrectAnswer | 正常流下一题 | 800ms | **400ms** |
| handleCorrectAnswer | 行为后下一题 | 400ms | **300ms** |
| handleWrongAnswer | 蓄力延迟 | 500ms | **与反馈并行** |
| monsterAttack | 护盾格挡后 | 1000ms | **700ms** |
| monsterAttack | 正常受击后 | 1000ms | **600ms** |
| monsterAttack | 复活后 | 1500ms | **1000ms** |
| monsterDeath | 死亡→过渡 | 1200ms | **800ms** |
| battleFeedback | 反馈显示 | 1000ms | **600ms** |
| damageNumber | 漂浮 | 1600ms | **1000ms** |
| monsterQuip | 台词 | 1000ms | **700ms** |
| attackNameDisplay | 攻击名 | 1200ms | **800ms** |
| itemDrop | 掉落动画 | 1500ms | **1000ms** |

#### monster-behavior.js

| 行为 | 当前 | 新值 |
|------|------|------|
| dodge | 1000ms | **700ms** |
| taunt | 1200ms | **800ms** |
| enrage | 1500ms | **1000ms** |
| fear | 1200ms | **800ms** |
| defend | 1200ms | **800ms** |
| summon | 1500ms | **1000ms** |
| escape | 1500ms | **1000ms** |
| selfDestruct | 1000ms | **800ms** |
| heal | 1200ms | **800ms** |

#### behavior-v2.js

| 行为 | 当前 | 新值 |
|------|------|------|
| counter | ~1050ms | **~750ms** |
| split | ~1300ms | **~900ms** |
| curse | ~1000ms | **~700ms** |
| shield | ~900ms | **~650ms** |
| transform | ~1500ms | **~1100ms** |

#### CSS动画同步

需要同步更新的CSS动画（css/style.css）：

| 动画 | 当前 | 新值 |
|------|------|------|
| hero-attack | 0.5s | **0.35s** |
| hero-cast | 0.3s | **0.2s** |
| hero-hit | 0.4s | **0.3s** |
| enemy-hit-arena | 0.3s | **0.25s** |
| enemy-attack-arena | 0.5s | **0.35s** |
| enemy-threaten-arena | 0.8s | **0.6s** |
| enemy-death-arena | 1s | **0.7s** |
| enemy-dodge | 0.4s | **0.3s** |
| weapon-fly | 0.4s | **0.3s** |
| projectile-fly-right/left | 0.5s | **0.35s** |
| damage-pop | 0.8s | **0.6s** |
| quip-pop | 1s | **0.7s** |
| stage-text-pop | 0.5s | **0.4s** |
| stage-monster-appear | 0.6s | **0.5s** |
| combo-break-flash | 0.8s | **0.6s** |

---

## 五、实施计划

### Phase 1：核心时限重校准（~1h）

1. 修改 `battle-combat.js` 的答题时限和危险区参数
2. 修改 `move-system.js` 的速度评级阈值
3. 修改 `practice.js` 的练习模式时限
4. 添加题目类型系数逻辑

### Phase 2：郊狼时间 + 失败保护（~1.5h）

1. 实现郊狼时间机制
2. 实现连续答错的守护之光
3. 实现超时重做（Easy/Normal）
4. 实现血量极低保护

### Phase 3：气势值系统（~1.5h）

1. 创建 `momentum-system.js`
2. 在 `battle-combat.js` 中接入气势值
3. 实现隐藏的时间调整
4. 实现怪物"失手"逻辑

### Phase 4：动画节奏压缩（~2h）

1. 修改 `hero-system.js` 5个攻击函数的时长
2. 修改 `battle-arena.js` 的入场/攻击/受击动画
3. 修改 `battle-combat.js` 的各种延迟
4. 修改 `monster-behavior.js` 9个行为时长
5. 修改 `behavior-v2.js` 5个行为时长
6. 修改 `combo-engine.js` 连击中断时长
7. 同步更新 `css/style.css` 中的CSS动画

### Phase 5：测试验证（~1h）

1. 语法检查所有修改的文件
2. 功能验证清单测试
3. 体感测试（实际游玩一轮完整战斗）

---

## 六、验证清单

### 计时器

- [ ] Easy模式基础时限为8秒
- [ ] Normal模式基础时限为5秒
- [ ] Hard模式基础时限为3.5秒
- [ ] 分数题在Normal下有7秒（5×1.4）
- [ ] 大九九题在Easy下有10.4秒（8×1.3）

### 郊狼时间

- [ ] 倒计时到0后，500ms内（Normal）提交答案仍有效
- [ ] 郊狼时间内答对显示"千钧一发！"
- [ ] 郊狼时间内答对速度评级自动为C

### 气势值

- [ ] 连续答对5题后，下一题时间不会变长
- [ ] 连续答错3题后，下一题时间明显变长（+30%）
- [ ] Easy模式气势值不低于20、不高于80
- [ ] 气势值变化对玩家不可见（UI无任何显示）

### 失败保护

- [ ] 连续答错3题后出现鼓励语
- [ ] HP=1时怪物有概率失手
- [ ] Easy/Normal模式第一次超时给重做机会
- [ ] Hard模式不给重做机会

### 动画节奏

- [ ] 答对→下一题的总等待 ≤ 1.5秒（普通攻击）
- [ ] 答错→下一题的总等待 ≤ 2.5秒
- [ ] 关卡过渡总时间 ≤ 3秒
- [ ] 怪物入场总时间 ≤ 1.5秒

### 速度评级

- [ ] Easy模式S级为≤2秒（原1.5秒）
- [ ] Normal模式S级为≤1.5秒（原1.2秒）
- [ ] Hard模式S级为≤1秒（原0.8秒）

---

## 七、参考资料

| 来源 | 内容 |
|------|------|
| 英国MTC国家测试 | 6秒/题，8-9岁，25题 |
| XtraMath | 流利度阈值3秒，宽松模式6秒，早期学习者12秒 |
| Rocket Math | 年级流利度标准：2年级20题/分 → 5年级50题/分 |
| Caviola et al. (2017) | 时间压力作为焦虑源，影响策略选择 |
| Csikszentmihalyi | 心流理论：难度-技能平衡 |
| RE4 DDA系统 | 隐藏Rank 1-10，难度帽设计 |
| Mario Kart橡皮筋 | 三层机制：速度+道具+行为 |
| Hades God Mode | 累积2%减伤/死 |
| Celeste郊狼时间 | 5帧（~83ms）宽限期 |
| DDR/ITG | 分级判定窗口（Perfect ±33ms → Miss ±225ms） |
| Prodigy Math | 基于正确率的自适应，ZPD |
| Khan Academy | 间隔重复精通系统 |
