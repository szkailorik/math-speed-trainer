# v17.0 PRD: 主角出招系统大改 — 速度判定 + 绝境反击 + 招式多样化

> 版本: v17.0 Draft v1
> 基础版本: v16.2 (攻击动画 + 倒计时 + 智能出题 + 闪避优化)
> 日期: 2026-02-10
> 状态: 设计讨论稿
> 目标用户: 3-4年级小学生

---

## 一、核心问题

当前主角的攻击系统存在以下问题:

| 问题 | 现状 | 影响 |
|------|------|------|
| **出招单调** | 同一个连击阶段永远同一个动画，看5次就腻了 | 小朋友丧失新鲜感 |
| **速度无感** | 答得快和答得慢，攻击演出完全一样 | 没有"我变厉害了"的正反馈 |
| **绝境无惊喜** | HP只剩1时和满血时出招完全一样 | 缺少绝地翻盘的爽感 |
| **武器无意义** | 6种武器只是不同emoji，手感完全一样 | 武器系统形同虚设 |
| **反应无奖励** | answerTime只影响闪避判定，不影响攻击 | 快速答题缺乏激励 |

---

## 二、设计理念

参考格斗游戏（街霸/拳皇）的出招判定思路:

```
┌─────────────────────────────────────────────────┐
│              出招判定公式                          │
│                                                   │
│  最终招式 = f(答题速度, 连击数, HP状态, 武器类型)    │
│                                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 速度评级  │ +│ 连击阶段  │ +│ 状态触发  │        │
│  │ S/A/B/C  │  │ 5个阶段   │  │ 绝境/护盾 │        │
│  └──────────┘  └──────────┘  └──────────┘        │
│        ↓              ↓             ↓             │
│   招式池选择      伤害倍率      特殊演出           │
└─────────────────────────────────────────────────┘
```

**核心原则**:
1. **快即是强** — 秒答触发华丽必杀，慢答只有普通攻击
2. **绝境翻盘** — HP=1时触发"绝境反击"特殊招式，给小朋友惊喜
3. **招式池随机** — 每个速度等级有3-4种不同招式随机出现，保持新鲜感
4. **武器差异化** — 不同武器有不同特效和音效，不再是换皮
5. **过程可见** — 速度评级、招式名全部可视化，让孩子知道"为什么这次更厉害"

---

## 三、速度评级系统

### 3.1 四档速度评级

根据答题用时，给出 S/A/B/C 四个评级（阈值随难度调整）:

| 评级 | Easy模式 | Normal模式 | Hard模式 | 含义 | 伤害倍率 |
|------|----------|------------|----------|------|----------|
| **S 极速** | < 1.5s | < 1.2s | < 0.8s | 闪电般反应 | ×1.5 |
| **A 迅捷** | 1.5-3.0s | 1.2-2.0s | 0.8-1.3s | 很快 | ×1.2 |
| **B 普通** | 3.0-4.5s | 2.0-2.8s | 1.3-1.8s | 正常速度 | ×1.0 |
| **C 缓慢** | > 4.5s | > 2.8s | > 1.8s | 慢慢想 | ×0.8(最少1) |

### 3.2 速度评级 UI 展示

答对后在战场中央短暂显示评级:

```
  ┌─────────────┐
  │   ⚡ S 极速!  │  ← 金色大字，缩放弹出，1秒消失
  └─────────────┘

  ┌─────────────┐
  │   💨 A 迅捷  │  ← 蓝色，普通弹出
  └─────────────┘

  ┌─────────────┐
  │   ✓ B 普通   │  ← 白色，轻微弹出
  └─────────────┘

  ┌─────────────┐
  │   🐢 C 慢慢来 │  ← 灰色，淡入淡出
  └─────────────┘
```

**设计要点**:
- C评级文案用鼓励语气"慢慢来"而非"太慢了"，保护孩子自尊心
- S评级加特效: 金色光晕 + 闪烁粒子
- 评级弹出动画 0.8s，不阻塞后续攻击动画

---

## 四、招式池系统

### 4.1 架构：每个评级×连击阶段 = 不同招式池

不再是"连击阶段决定唯一攻击动画"，改为每次从招式池中随机选一招:

```
速度评级(S/A/B/C) × 连击阶段(5) → 招式池(3-4招) → 随机选1招
```

### 4.2 招式总表（20个基础招式）

#### C评级招式（基础招，4个）

| 招式名 | emoji | 描述 | 动画 | 音效关键词 |
|--------|-------|------|------|-----------|
| 轻拍 | 👋 | 轻轻一拍 | 主角手臂前伸，小波纹 | 轻拍 pap |
| 扔石头 | 🪨 |දදිdiy投掷 | 抛物线小石头 | 丢 thud |
| 魔法飞沫 | ✨ | 零星火花 | 2-3颗小星星散射 | 微弱 twinkle |
| 书本砸 | 📖 | 用课本砸 | 书本旋转飞出 | 砰 bonk |

**设计意图**: 可爱、不丢脸，孩子看了觉得好笑而不是沮丧

#### B评级招式（标准招，4个）

| 招式名 | emoji | 描述 | 动画 | 音效关键词 |
|--------|-------|------|------|-----------|
| 火球术 | 🔥 | 标准火球 | 水平火球+尾焰 | 嗖 woosh |
| 冰冻箭 | 🧊 | 冰箭射击 | 水平冰箭+碎冰粒子 | 咻 frost |
| 闪电链 | ⚡ | 电击攻击 | 锯齿形闪电线 | 啪 zap |
| 旋风斩 | 🌀 | 旋转攻击 | 螺旋风刃飞出 | 呼 whirl |

#### A评级招式（强力招，4个）

| 招式名 | emoji | 描述 | 动画 | 音效关键词 |
|--------|-------|------|------|-----------|
| 流星冲击 | ☄️ | 流星撞击 | 45度斜线坠落+爆炸 | 轰 meteor |
| 光之箭雨 | 🏹 | 连续射箭 | 3支箭连射 | 嗖嗖嗖 triple-shot |
| 雷神之锤 | 🔨 | 巨锤砸下 | 巨大锤子从上砸下+震屏 | 咚 thunder-smash |
| 彩虹光束 | 🌈 | 彩虹激光 | 彩虹色横向光束 | 唰 beam |

#### S评级招式（必杀技，4个）

| 招式名 | emoji | 描述 | 动画 | 音效关键词 |
|--------|-------|------|------|-----------|
| 星辰爆发 | 🌟 | 漫天星辰 | 屏幕变暗→星星爆炸→震屏 | 史诗 supernova |
| 凤凰烈焰 | 🔥 | 火凤飞出 | 凤凰形火焰横穿+全屏闪光 | 凤鸣 phoenix |
| 龙卷万刃 | 🐉 | 龙形攻击 | 龙形能量波+连续打击 | 龙吟 dragon |
| 天降正义 | ⚖️ | 天罚之光 | 从天而降金色光柱 | 神圣 divine |

#### 特殊招式（状态触发，4个）

| 招式名 | 触发条件 | emoji | 描述 | 动画 |
|--------|----------|-------|------|------|
| **绝境反击** | HP=1时答对 | 💢 | 爆发反击 | 红色气场爆发→冲刺攻击→全屏震动 |
| **护盾冲撞** | 有护盾时答对 | 🛡️ | 盾牌撞击 | 盾牌前冲+怪物后退 |
| **连击终结** | 连击10+且S评级 | ⭐ | 超级终结技 | combo数字特效+超级武器释放 |
| **绝杀一击** | 怪物剩1HP时 | 💀 | 处决攻击 | 慢动作特写+致命一击标志 |

### 4.3 招式选择算法

```javascript
function selectMove(speedRank, comboStage, battleState) {
    // 1. 优先检查特殊触发
    if (battleState.playerHP === 1) return specialMoves.desperateCounter;
    if (battleState.monsterHP === 1) return specialMoves.finishingBlow;
    if (comboStage >= 'godlike' && speedRank === 'S') return specialMoves.comboFinisher;
    if (battleState.shield > 0) return specialMoves.shieldBash;  // 20%概率触发

    // 2. 基于速度评级选招式池
    let pool = movePools[speedRank];  // C/B/A/S 对应的招式数组

    // 3. 连击阶段提升: 高连击可以从上一级池中借招
    //    例如: B评级 + will阶段(5连) → 30%概率从A池中抽
    if (comboStage >= 'will' && speedRank !== 'S') {
        if (Math.random() < 0.3) {
            pool = movePools[nextRank(speedRank)];
        }
    }

    // 4. 从池中随机选一招（加权，避免连续重复）
    return weightedRandom(pool, lastUsedMove);
}
```

---

## 五、绝境反击系统

### 5.1 触发条件

| 条件 | 值 |
|------|------|
| 玩家HP | = 1（最后一条命） |
| 答题结果 | 答对 |
| 冷却 | 每场战斗最多触发3次 |

### 5.2 演出流程（总计 1.5s）

```
时间轴:
0ms     → 屏幕变红闪烁 + 主角浮起
200ms   → 红色气场粒子爆发（8-12颗💢粒子向外扩散）
400ms   → 主角冲向怪物（dash动画）
600ms   → 全屏震动(heavy) + 巨大"💢"命中特效
800ms   → 伤害数字弹出（比普通大1.5倍，红色）
1000ms  → 主角返回 + "绝境反击!"文字弹出
1500ms  → 恢复正常
```

### 5.3 绝境反击效果

- **伤害**: 当前基础伤害 ×2（至少2点）
- **视觉**: 红色气场 + 全屏震动 + 大号伤害数字
- **音效**: 低沉蓄力音 → 爆发音（类似格斗游戏超必杀音效）
- **文字**: "💢 绝境反击!" （红色大字闪烁弹出）
- **附加**: 触发后恢复1HP（奖励坚持到最后的孩子）

### 5.4 设计理由

小朋友在HP=1的紧张时刻答对题，应该获得**最大的正反馈**。这种"越危险越厉害"的机制在格斗游戏中非常经典（街霸的Ultra Combo、拳皇的MAX超必杀），能让孩子:
- 不惧怕"快死了"的压力
- 感受到"坚持到最后的奖励"
- 产生"好厉害！再来一次"的动力

---

## 六、武器差异化系统

### 6.1 当前问题

6种武器（🔥🧊⚡⭐🌈💣）目前只有emoji不同，飞行动画、音效、打击感完全一样。

### 6.2 改造方案：每种武器独特飞行效果

| 武器 | 飞行轨迹 | 命中特效 | 尾迹颜色 | 特殊能力 |
|------|----------|----------|----------|----------|
| 🔥 火球 | 直线+尾焰抖动 | 爆炸火花 | 橙红渐变 | 命中后怪物闪红光 |
| 🧊 冰箭 | 直线快速 | 冰晶碎裂 | 浅蓝 | 命中后怪物短暂变蓝(冻结感) |
| ⚡ 闪电 | 锯齿形路径 | 电弧闪烁 | 黄色 | 瞬间命中(无飞行时间) |
| ⭐ 流星 | 45度弧线 | 金色爆发 | 金色 | 命中散出3颗小星星 |
| 🌈 彩虹 | 波浪形路径 | 彩色漫开 | 彩虹渐变 | 命中后短暂彩虹光环 |
| 💣 炸弹 | 抛物线 | 大爆炸+震屏 | 灰色烟尾 | +1伤害(保留) + 大范围爆炸 |

### 6.3 武器×速度评级联动

武器不再完全随机，高速度评级更容易获得高级武器:

| 速度评级 | 权重调整 |
|----------|---------|
| S | ⭐🌈💣 概率×3 |
| A | ⭐🌈 概率×2 |
| B | 正常权重 |
| C | 🔥🧊 概率×2（基础武器更多） |

---

## 七、绝杀一击系统

### 7.1 触发条件

| 条件 | 值 |
|------|------|
| 怪物HP | = 1（最后一滴血） |
| 答题结果 | 答对 |

### 7.2 演出流程（总计 1.2s）

```
时间轴:
0ms     → 时间减慢效果（arena加0.3s transition）
200ms   → "致命一击!"文字出现（金色，从小到大）
400ms   → 武器放大2倍飞出 + 浓烈尾迹
600ms   → 命中 → 💀emoji闪现 + 全屏白光闪
800ms   → 怪物死亡动画触发
1200ms  → 恢复正常
```

### 7.3 效果

- **视觉**: 慢动作 → 放大武器 → 白色闪光 → 💀标记
- **音效**: 时间减慢的低沉音 → 重击音 → 碎裂音
- **文字**: "💀 绝杀!" （金色大字）
- **目的**: 击杀最后一滴血的瞬间要有"终结"的仪式感

---

## 八、速度评级 + 连击阶段 交叉矩阵

下表展示每种组合下的表现差异:

| | C 缓慢 | B 普通 | A 迅捷 | S 极速 |
|---|--------|--------|--------|--------|
| **普通 (0-2)** | 轻拍/扔石头 | 火球/冰箭 | 火球/闪电 | 流星/光箭 |
| **觉醒 (3-4)** | 火球/旋风 | 火球/闪电/旋风 | 流星/光箭 | 流星/彩虹光 |
| **战意 (5-9)** | 火球/冰箭/旋风 | 闪电/旋风+30%升级 | 流星/雷锤/光箭 | 必杀技池 |
| **超神 (10-14)** | 标准招+30%升级 | A招+30%升级 | S招+30%升级 | 必杀技+连击终结 |
| **无敌 (15+)** | A级招式 | S级招式 | 必杀技 | 必杀技+必定连击终结 |

**"升级"**: 从上一级招式池中抽取，体现连击的加成作用。
**核心体验**: 即使答得慢(C)，只要连击够高(无敌)，也能打出A级招式 — 鼓励持续答对。

---

## 九、UI/UX 改动

### 9.1 速度评级显示区

在战斗区域中央偏上增加评级显示:

```html
<div class="speed-rank-display" id="speed-rank-display">
    <span class="speed-rank-icon" id="speed-rank-icon"></span>
    <span class="speed-rank-text" id="speed-rank-text"></span>
</div>
```

### 9.2 招式名显示

每次攻击时在主角头顶弹出招式名:

```html
<div class="move-name-popup" id="move-name-popup"></div>
```

### 9.3 绝境警告

HP=1时全局红色边框闪烁提示:

```css
.battle-arena.danger-mode {
    box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.3);
    animation: danger-pulse 1s ease-in-out infinite;
}
```

---

## 十、实现方案

### 10.1 新增文件

| 文件 | 内容 | 估计行数 |
|------|------|---------|
| `js/move-system.js` | 招式池定义 + 选择算法 + 动画执行 | ~400行 |

### 10.2 修改文件

| 文件 | 改动 |
|------|------|
| `js/battle-combat.js` | handleCorrectAnswer: 加入速度评级计算 → 招式选择 → 替代原 executeComboAttack |
| `js/hero-system.js` | 保留 initHeroLayers，5个attack方法改为被 move-system 调用的基础动画库 |
| `js/battle-arena.js` | 新增武器差异化飞行动画（6种轨迹）、绝境反击动画、绝杀一击动画 |
| `js/effects.js` | 新增 ~10 个音效: 4个速度评级音、绝境反击音、绝杀音、各武器独立音 |
| `css/style.css` | 速度评级弹出、招式名弹出、绝境红色边框、武器6种轨迹、绝杀慢动作 |
| `index.html` | 新增速度评级 + 招式名 DOM 元素 |

### 10.3 改造关键流程

```
答对
  ↓
计算 answerTime → 速度评级 (S/A/B/C)
  ↓
显示速度评级动画 (不阻塞，叠加显示)
  ↓
检查特殊触发 (绝境反击 / 绝杀一击 / 连击终结 / 护盾冲撞)
  ↓
是 → 执行特殊招式动画
否 → selectMove(speedRank, comboStage) → 从招式池随机选一招
  ↓
显示招式名弹出
  ↓
执行招式动画 (主角动作 + 武器飞行 + 命中特效)
  ↓
计算最终伤害 = baseDamage × speedMultiplier × comboBonus
  ↓
dealDamage()
```

### 10.4 向后兼容

- `hero-system.js` 的5个attack方法保留，作为底层动画调用
- `combo-engine.js` 不变，连击阶段仍由它管理
- 原有伤害公式保留，速度评级只是额外倍率
- `getRandomWeapon()` 保留，但权重受速度评级影响

---

## 十一、数据结构

### 11.1 招式定义

```javascript
const MovePool = {
    S: [
        { name: '星辰爆发', emoji: '🌟', type: 'magic',
          animation: 'supernova', sound: 'attackSupernova',
          particles: ['🌟','⭐','💫','✨'], particleCount: 15,
          screenShake: 'heavy', screenFlash: true },
        // ... 3 more
    ],
    A: [ /* 4 moves */ ],
    B: [ /* 4 moves */ ],
    C: [ /* 4 moves */ ],
    special: {
        desperateCounter: { /* 绝境反击 */ },
        finishingBlow:    { /* 绝杀一击 */ },
        comboFinisher:    { /* 连击终结 */ },
        shieldBash:       { /* 护盾冲撞 */ }
    }
};
```

### 11.2 速度评级配置

```javascript
const SpeedRankConfig = {
    easy:   { S: 1500, A: 3000, B: 4500 },  // ms阈值，超过B即为C
    normal: { S: 1200, A: 2000, B: 2800 },
    hard:   { S: 800,  A: 1300, B: 1800 }
};

const SpeedRankDisplay = {
    S: { icon: '⚡', text: '极速!',  color: '#FFD700', scale: 1.5 },
    A: { icon: '💨', text: '迅捷',   color: '#4A90D9', scale: 1.2 },
    B: { icon: '✓',  text: '普通',   color: '#FFFFFF', scale: 1.0 },
    C: { icon: '🐢', text: '慢慢来', color: '#888888', scale: 0.9 }
};
```

---

## 十二、验证清单

### 功能验证

- [ ] 答题速度评级正确显示 (S/A/B/C)
- [ ] S评级触发必杀级招式，C评级触发基础招式
- [ ] 同一评级多次答题，招式有变化（不重复）
- [ ] 连击提升可以让低评级使用更高级招式
- [ ] HP=1时答对触发绝境反击（红色气场+冲刺+回1HP）
- [ ] 绝境反击每场最多3次
- [ ] 怪物HP=1时答对触发绝杀一击（慢动作+放大武器+💀）
- [ ] 连击10+ + S评级触发连击终结技
- [ ] 有护盾时20%概率触发护盾冲撞
- [ ] 6种武器各有不同飞行轨迹和命中特效
- [ ] 速度评级影响武器掉落权重

### 体验验证

- [ ] 各招式动画流畅，不卡顿（总时长 < 1.5s）
- [ ] 评级弹出不阻塞游戏流程
- [ ] C评级文案温和鼓励，不打击孩子
- [ ] 绝境反击有足够的"爽感"和惊喜感
- [ ] 10种以上不同的攻击演出，玩10分钟内不会重复到腻

### 技术验证

- [ ] 所有 JS 文件通过 `node -c` 语法检查
- [ ] 退出战斗后所有动画/音效正确终止
- [ ] move-system.js 不影响现有 combo-engine 和 behavior 系统
- [ ] 向后兼容: 旧存档玩家无异常

---

## 十三、开发优先级

| 阶段 | 内容 | 估时 |
|------|------|------|
| Phase 1 | 速度评级系统 + UI显示 | 核心机制 |
| Phase 2 | move-system.js 招式池 + 选择算法 | 核心机制 |
| Phase 3 | 16个基础招式动画 (C×4 + B×4 + A×4 + S×4) | 主要工作量 |
| Phase 4 | 4个特殊招式 (绝境反击 + 绝杀 + 连击终结 + 护盾冲撞) | 亮点功能 |
| Phase 5 | 武器差异化 (6种飞行轨迹+命中特效) | 锦上添花 |
| Phase 6 | 音效 + 最终调优 | 收尾打磨 |
