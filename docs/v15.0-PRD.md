# v15.0 PRD: 第三人称对战视角 + 战斗体验全面升级

> 版本: v15.0 Draft v1
> 基础版本: v14.0 (蜂群模块化架构)
> 日期: 2026-02-10
> 状态: 待产品经理打磨

---

## 一、版本目标

在 v14.0 蜂群模块化架构基础上，对**战斗模式**进行全面升级：

1. **第三人称对战视角**：从当前的"怪物展示 + 答题"改为"主角 VS 怪物面对面"的横版对战布局
2. **战斗动画升级**：主角攻击/受击/技能动画，怪物行为变化，打击感增强
3. **怪物智能行为**：怪物在战斗中根据数学题目表现出不同行为（闪避、嘲讽、愤怒、逃跑等）
4. **稀有卡牌掉落系统**：战斗中掉落可收集的稀有卡牌，卡牌有独立图鉴和升级机制
5. **特殊成就体系扩展**：围绕新系统设计 15+ 个新成就

---

## 二、核心改动：第三人称对战视角

### 2.1 当前现状（v14.0）

```
┌──────────────────────────┐
│  关卡 1/6     ❤️❤️❤️❤️❤️  │  <- 顶部信息栏
│                          │
│       👻 噗噗鬼          │  <- 怪物区域（居中展示）
│    ████████░░  5/5       │  <- 怪物血条
│                          │
│     🔥                   │  <- 武器飞行区域
│                          │
│   ┌─── 6 × 7 = ? ───┐  │  <- 题目卡片
│   │  🔥连击 3         │  │
│   └──────────────────┘  │
│                          │
│  ┌──12──┐ ┌──42──┐     │  <- 选择按钮
│  ┌──36──┐ ┌──48──┐     │
└──────────────────────────┘
```

**问题**：
- 没有主角形象，玩家没有代入感
- 怪物只是静态展示，缺少"对战"氛围
- 武器从下往上飞，但不知道是"谁"在攻击

### 2.2 目标布局（v15.0 第三人称横版对战）

```
┌──────────────────────────┐
│  关卡 1/6                │  <- 顶部状态栏
│                          │
│  ┌─────────────────────┐ │
│  │  🧙        VS  👻   │ │  <- 对战舞台
│  │ 勇者            噗噗鬼│ │
│  │ ❤️❤️❤️❤️❤️   5/5 ████ │ │  <- 双方血条
│  │                      │ │
│  │   🔥 ──────→  💥    │ │  <- 武器/攻击动画轨迹
│  │                      │ │
│  └─────────────────────┘ │
│                          │
│  ┌─── 6 × 7 = ? ───┐   │  <- 题目区域
│  │  道具栏: 🧪💎🛡️   │   │  <- 道具栏
│  └──────────────────┘   │
│                          │
│  [12]  [42]  [36]  [48]  │  <- 选择按钮
└──────────────────────────┘
```

### 2.3 对战舞台详细设计

#### 舞台区域 (`.battle-arena`)
- 占屏幕上方约 40% 高度
- 背景：根据模块主题切换
  - 小九九：暗紫魔法城堡
  - 山海经(分数)：远古山水
  - 西游记(小数)：云海仙境
  - 封神演义(单位)：商周殿堂
  - 聊斋志异(乘法)：月夜古宅
  - 哈利波特(大九九)：霍格沃茨走廊
- 地面线：舞台底部 20% 处画一条地面分隔线

#### 主角 (`.hero-character`)
- 位置：舞台左侧 20% 处
- 大小：约 4rem emoji
- 默认角色：🧙（可在后续版本做自定义角色选择）
- 名称显示：当前用户名
- 血条：在主角下方，左对齐
- 动画状态：
  - **idle**：轻微上下浮动（2s 循环）
  - **attack**：向右冲刺 30px → 回弹（0.5s）
  - **cast_spell**：发光 + 放大 1.2x（0.3s）→ 发射武器
  - **hit**：向左弹退 15px + 闪红（0.3s）
  - **heal**：绿色光环 + 上浮 +1 文字
  - **victory**：跳跃 + 旋转 + 星星特效
  - **defeat**：倒下动画（向左倾斜 + 淡出）

#### 怪物 (`.enemy-character`)
- 位置：舞台右侧 80% 处
- 大小：根据怪物等级变化
  - Easy: 3.5rem
  - Normal: 4rem
  - Hard: 4.5rem
  - Boss: 5rem + 特殊光环
- 血条：在怪物下方，右对齐
- 动画状态：
  - **idle**：呼吸缩放（3s 循环）+ 左右微晃
  - **hit**：右弹退 15px + 亮白闪烁（0.3s）
  - **attack**：向左冲刺 40px + 攻击 emoji 发射（0.5s）
  - **threaten**：放大 1.1x + 震动（答错时）
  - **weak**：HP < 30% 时倾斜 + 颤抖 + 冒汗 emoji
  - **enrage**：HP < 50% 时变红 + 加速呼吸
  - **death**：旋转缩小 + 爆炸粒子 + 分数飘字

#### 中间对战区域
- VS 分隔：不显示固定 VS 文字，用攻击动画轨迹体现对抗关系
- 攻击轨迹：
  - 主角攻击：武器 emoji 从左向右飞行，带拖尾粒子
  - 怪物攻击：攻击 emoji 从右向左飞行
- 伤害数字：在被击中方上方弹出
  - 主角受击：红色数字 `-1` 从主角位置弹出
  - 怪物受击：金色数字 `-2` 从怪物位置弹出

---

## 三、怪物智能行为系统

### 3.1 设计理念

怪物不再只是"被打的靶子"，而是会根据战斗进程和玩家表现做出反应，让数学训练过程更有趣。

### 3.2 怪物行为列表

| 行为 | 触发条件 | 视觉表现 | 对游戏影响 |
|------|----------|----------|-----------|
| **闪避** | 答对后 15% 概率（仅调皮系怪物） | 怪物快速左移 + "闪!" 文字 | 本次伤害无效，需再答一题 |
| **嘲讽** | 玩家答错时 | 怪物跳跃 + 台词气泡 "哈哈~" | 纯视觉，增加情绪 |
| **愤怒** | HP 低于 50% | 怪物变红 + 加速呼吸 + 台词 "可恶!" | 怪物攻击伤害 +1（限 Hard 难度） |
| **恐惧** | 玩家连击 >= 5 | 怪物颤抖 + 冒汗 + "好厉害..." | 纯视觉，增强成就感 |
| **防御** | Boss 怪物每 3 回合触发一次 | 怪物举盾 + "挡!" | 本次伤害减半（向上取整） |
| **召唤** | Boss 怪物 HP < 30% 触发一次 | "召唤小弟!" + 小怪 emoji 飞入 | 额外增加 1 道题才能继续攻击 Boss |
| **逃跑尝试** | Easy 怪物 HP = 1 时 30% 概率 | 怪物转身 + "溜了溜了~" | 如果下一题答对就击杀，答错就跑了（不算击败但不扣血） |
| **自爆** | 毒系/火系怪物死亡时 | 爆炸特效 + "同归于尽!" | 玩家 -1 HP（可被护盾抵挡） |
| **治愈** | 仙/精灵系怪物每 5 回合 | 绿色光环 + "+1" | 怪物回复 1 HP |

### 3.3 怪物台词系统增强

当前每个怪物有 3 条 `quips`（受击台词），增加以下台词类型：

```javascript
{
    quips: ['哎呦!', '好痛!', '呜呜...'],       // 受击
    tauntQuips: ['哈哈~', '太弱了~', '再来啊~'],  // 嘲讽（答错时）
    fearQuips: ['好厉害...', '不要过来!', '救命!'], // 恐惧（被连击时）
    deathQuips: ['下次不会输的...', '记住我!'],    // 死亡
    enterQuips: ['来挑战我吧!', '你准备好了吗?']   // 登场
}
```

### 3.4 怪物登场演出

当前的 `showStageTransition()` 只显示文字信息。升级为：

1. 屏幕变暗 (0.3s)
2. 怪物从右侧滑入舞台 (0.5s)
3. 怪物做登场动作（放大 → 回弹）+ 台词气泡 (0.8s)
4. 怪物名称 + 类型 + HP 信息渐入 (0.3s)
5. "战斗开始!" 文字闪现 (0.5s)
6. 题目出现

总时长约 2.5s（当前 1.5s），但用动画填充所以不会感觉拖沓。

---

## 四、战斗动画升级

### 4.1 主角攻击动画序列（答对时）

```
[答对] → 主角 cast_spell (0.2s)
       → 武器 emoji 从主角飞向怪物 (0.4s)
         - 轨迹：抛物线或直线（根据武器类型）
         - 粒子拖尾：武器颜色的小圆点
       → 怪物 hit 动画 (0.3s)
       → 伤害数字弹出 (0.5s)
       → 怪物 HP 条平滑下降 (0.3s)
       → 连击数更新 + 连击特效 (0.3s)
```

### 4.2 怪物攻击动画序列（答错时）

```
[答错] → 按钮变红 + 显示正确答案 (0.3s)
       → 怪物 threaten 动画 (0.5s)
       → 怪物攻击 emoji 从怪物飞向主角 (0.4s)
       → 主角 hit 动画 (0.3s) + 屏幕闪红
       → 主角 HP 减少动画（心跳碎裂效果）
       → 怪物嘲讽台词气泡 (0.8s)
```

### 4.3 连击特效升级

| 连击数 | 特效 |
|--------|------|
| 3 | 🔥 文字 + 火焰粒子围绕主角 |
| 5 | ⚡ 文字 + 主角发光 + 地面震波 |
| 10 | 💥 文字 + 全屏金色粒子 + 主角变身（emoji 变大 + 光环）|
| 15 | 🌟 文字 + 黑屏闪白 + "超神!" 大字 + 庆祝烟花 |
| 20 | 👑 文字 + 全屏彩虹 + 主角头顶皇冠 + BGM 加速（如果有）|

### 4.4 Boss 战特殊演出

- Boss 登场：全屏变暗 → Boss emoji 从上方缓慢落下 → 地面震动效果 → 特殊 BGM 音效
- Boss 血量过半：Boss 进入愤怒状态，背景变深红
- Boss 死亡：分多阶段爆炸 → 散落大量粒子 → 慢动作效果 (0.5s 内 3 次爆炸)

### 4.5 动画性能优化

- 所有动画元素加 `will-change: transform`
- 用 `transform` 和 `opacity` 替代 `top/left` 动画
- 移动端粒子数量上限 50 个
- 超时粒子自动清理（5s 后 remove）
- 使用 `requestAnimationFrame` 控制帧率

---

## 五、稀有卡牌掉落系统

### 5.1 设计理念

战斗中除了现有的"道具掉落"外，增加一套独立的**卡牌收集系统**。卡牌是长期收集目标，比道具更稀有、更有收藏价值。

### 5.2 卡牌类型

| 稀有度 | 颜色边框 | 掉落率 | 说明 |
|--------|----------|--------|------|
| ⬜ 普通 (N) | 灰白 | 12% | 基础卡牌，数学知识卡 |
| 🟦 稀有 (R) | 蓝色 | 5% | 怪物专属卡，附带故事片段 |
| 🟪 史诗 (SR) | 紫色 | 1.5% | 武器技能卡，战斗中可使用 |
| 🟨 传说 (SSR) | 金色发光 | 0.3% | 极稀有收藏卡，特殊动画 |
| 🌈 神话 (UR) | 彩虹流光 | 0.05% | 全系列仅 6 张，每个模块 1 张 |

### 5.3 卡牌数据结构

```javascript
{
    id: 'card_fire_mastery',
    name: '火焰精通',
    rarity: 'SR',           // N, R, SR, SSR, UR
    type: 'skill',          // knowledge, monster, skill, legend, myth
    module: 'xiaojiujiu',   // 所属模块
    emoji: '🔥',
    illustration: '...',     // 卡面描述
    effect: {               // SR及以上有战斗效果
        type: 'damage_boost',
        value: 1,
        duration: 3          // 持续3回合
    },
    flavor: '掌握火焰的力量，让计算如烈火般迅速。',  // 卡牌故事文字
    unlockCondition: null    // null=随机掉落, 或特定条件
}
```

### 5.4 卡牌掉落机制

- **触发时机**：击败怪物时判定（不是答题时）
- **基础掉率**：根据难度
  - Easy: 基础 10%
  - Normal: 基础 15%
  - Hard: 基础 20%
- **加成因素**：
  - 无伤击杀当前怪物：+5%
  - 当前连击 >= 5：+3%
  - 使用道具击杀：+2%
  - Boss 怪物必掉 1 张（至少 R 级）
- **保底机制**：连续 10 只怪物未掉卡，第 11 只必掉

### 5.5 卡牌掉落动画

1. 怪物死亡爆炸后
2. 一张卡牌从爆炸中心飞出（0.3s）
3. 卡牌翻转动画（背面 → 正面，0.5s）
4. 稀有度光效：
   - N: 无特效
   - R: 蓝色闪光
   - SR: 紫色光柱 + 粒子
   - SSR: 金色爆炸 + 全屏闪光 + 震动
   - UR: 彩虹光幕 + 慢动作 + 特殊音效 + 3s 展示
5. 卡牌名称 + 稀有度标签显示 (0.5s)
6. 卡牌缩小飞入"卡包"图标 (0.3s)

### 5.6 卡牌图鉴页面

新增独立页面 `card-collection`：
- 入口：主页新增"卡牌图鉴"按钮
- 展示所有已收集卡牌，按稀有度分标签
- 未收集的显示为暗色卡背
- 点击已收集卡牌查看详情（翻转动画 + 全部信息）
- 顶部显示收集进度：`已收集 23/150 (15%)`
- SR 及以上卡牌可在战斗中"装备"使用

### 5.7 卡牌设计数量

| 模块 | N | R | SR | SSR | UR | 合计 |
|------|---|---|----|-----|----|----|
| 小九九 | 8 | 5 | 3 | 2 | 1 | 19 |
| 分数小数 | 8 | 5 | 3 | 2 | 1 | 19 |
| 小数规律 | 8 | 5 | 3 | 2 | 1 | 19 |
| 单位换算 | 8 | 5 | 3 | 2 | 1 | 19 |
| 乘法速记 | 8 | 5 | 3 | 2 | 1 | 19 |
| 大九九表 | 8 | 5 | 3 | 2 | 1 | 19 |
| 跨模块 | 4 | 3 | 2 | 1 | 0 | 10 |
| **合计** | **60** | **38** | **23** | **15** | **7** | **143** |

---

## 六、成就体系扩展

### 6.1 新增成就（15个）

#### 第三人称视角相关

| ID | 名称 | 图标 | 解锁条件 |
|----|------|------|----------|
| hero_first_strike | 初次出击 | ⚔️ | 在新视角下完成首次战斗 |
| hero_no_retreat | 永不退缩 | 🛡️ | 主角全程未被击退（无伤通关 Normal） |
| hero_berserker | 狂战士 | 😤 | 单局累计造成 50 点伤害 |

#### 怪物行为相关

| ID | 名称 | 图标 | 解锁条件 |
|----|------|------|----------|
| dodge_master | 反闪避大师 | 👁️ | 遇到怪物闪避后紧接着答对 |
| boss_summoner | 召唤终结者 | 🗡️ | Boss 召唤小弟后依然通关 |
| no_escape | 无处可逃 | 🏃 | 阻止怪物逃跑成功 3 次 |
| survive_self_destruct | 自爆幸存者 | 💥 | 扛住怪物自爆攻击 |

#### 稀有卡牌相关

| ID | 名称 | 图标 | 解锁条件 |
|----|------|------|----------|
| first_card | 初入卡池 | 🃏 | 获得第一张卡牌 |
| card_collector_10 | 卡牌新手 | 📋 | 收集 10 张不同卡牌 |
| card_collector_50 | 卡牌猎人 | 📦 | 收集 50 张不同卡牌 |
| sr_hunter | 史诗猎手 | 💜 | 收集 5 张 SR 级卡牌 |
| ssr_miracle | 传说奇迹 | ✨ | 获得 1 张 SSR 级卡牌 |
| ur_destiny | 命运之选 | 🌈 | 获得 1 张 UR 级卡牌 |
| full_set | 满套收藏 | 👑 | 收集某个模块全部卡牌 |
| card_master | 卡牌大师 | 🏆 | 收集全部 143 张卡牌 |

### 6.2 成就展示升级

- SSR 级成就解锁时：全屏金色特效 + 特殊音效 + 3s 展示
- 成就页面增加"稀有成就"分类标签
- 成就卡片增加解锁时间戳显示

---

## 七、数据增量（新增怪物）

### 7.1 新增怪物规划

每个模块增加 4-6 只新怪物，重点补充 Boss 和 Hard 难度：

| 模块 | 新增 Easy | 新增 Normal | 新增 Hard | 新增 Boss | 合计 |
|------|-----------|-------------|-----------|-----------|------|
| 小九九 | 2 | 2 | 2 | 1 | 7 |
| 分数小数 | 2 | 2 | 1 | 1 | 6 |
| 小数规律 | 2 | 2 | 1 | 1 | 6 |
| 单位换算 | 2 | 2 | 1 | 1 | 6 |
| 乘法速记 | 2 | 2 | 1 | 1 | 6 |
| 大九九 | 2 | 2 | 1 | 1 | 6 |
| **合计** | **12** | **12** | **7** | **6** | **37** |

### 7.2 新怪物设计要求

- 每只新怪物必须有：完整的 `quips` + `tauntQuips` + `fearQuips` + `deathQuips` + `enterQuips`
- 至少 3 只新怪物具有特殊行为（闪避/防御/自爆等）
- Boss 怪物必须有召唤能力
- 每只怪物的 `story` 和 `storyEn` 不少于 100 字

---

## 八、技术方案

### 8.1 影响的模块文件

| 文件 | 改动程度 | 改动内容 |
|------|----------|----------|
| `battle-combat.js` | **大改** | 第三人称布局逻辑、主角系统、新动画序列 |
| `battle-data.js` | **大改** | 新增怪物、卡牌数据、怪物行为配置 |
| `battle-collection.js` | **中改** | 新增卡牌图鉴页面 |
| `effects.js` | **中改** | 新动画特效函数、卡牌翻转动画 |
| `index.html` | **中改** | 新增对战舞台 HTML、卡牌图鉴页面 |
| `style.css` | **大改** | 新增全套对战动画 CSS、卡牌样式 |
| `core.js` | **小改** | App state 新增卡牌存储字段 |
| `ui-pages.js` | **小改** | 新增卡牌图鉴入口 |
| `data.js` | **小改** | 新增成就定义 |
| `practice.js` | 不改 | - |
| `daily.js` | 不改 | - |

### 8.2 新增文件

| 文件 | 行数估算 | 内容 |
|------|----------|------|
| `js/card-system.js` | ~400 行 | 卡牌数据定义 + 掉落逻辑 + 图鉴渲染 |
| `js/monster-behavior.js` | ~300 行 | 怪物智能行为状态机 |
| `js/battle-arena.js` | ~350 行 | 第三人称舞台渲染 + 主角系统 |

### 8.3 蜂群分工建议

| 蜂群 | 负责文件 | 任务 |
|------|----------|------|
| math-battle | battle-combat.js, battle-arena.js | 第三人称核心逻辑 |
| math-cards | card-system.js | 卡牌掉落 + 图鉴 |
| math-monster | battle-data.js, monster-behavior.js | 怪物行为 + 新怪物数据 |
| math-audio | effects.js | 新动画特效 + 音效 |
| math-bg | style.css | 对战舞台样式 + 动画 CSS |
| math-ui | ui-pages.js, index.html | 卡牌图鉴页面 + 主页入口 |
| math-arch | core.js, data.js | 数据结构 + 成就 |
| math-test | (测试) | 集成测试 |

### 8.4 数据存储

卡牌收集数据存储在 localStorage：

```javascript
// key: cardCollection_[userId]
{
    cards: ['card_fire_mastery', 'card_basic_addition', ...],
    equipped: ['card_fire_mastery'],  // 战斗中装备的卡牌
    totalDrops: 47,                    // 历史掉落总数
    pityCounter: 3                     // 保底计数器
}
```

---

## 九、开发与测试计划

### 9.1 开发阶段

| 阶段 | 内容 | 验收标准 |
|------|------|----------|
| **Phase 1** | 第三人称舞台布局 + 主角显示 | 主角和怪物面对面显示，基本攻击动画 |
| **Phase 2** | 攻击/受击动画序列完善 | 答对/答错的完整动画链无卡顿 |
| **Phase 3** | 怪物智能行为 | 至少 3 种行为（闪避/嘲讽/愤怒）正常触发 |
| **Phase 4** | 卡牌掉落系统 | 战斗中能掉卡、能查看图鉴 |
| **Phase 5** | 新怪物 + 新成就 | 37 只新怪物 + 15 个新成就 |
| **Phase 6** | 性能优化 + 自测 | iPad PWA 流畅运行，无 console error |

### 9.2 自测清单

#### 第一轮：功能测试
- [ ] 第三人称舞台：主角和怪物正确显示
- [ ] 主角攻击动画：答对后主角施法 → 武器飞行 → 怪物受击
- [ ] 怪物攻击动画：答错后怪物攻击 → 主角受击 → 血量减少
- [ ] 怪物闪避：调皮系怪物偶尔闪避成功
- [ ] 怪物嘲讽：答错时显示嘲讽台词
- [ ] 怪物愤怒：HP 过半后变红
- [ ] Boss 召唤：Boss 低血时召唤小弟
- [ ] 卡牌掉落：击败怪物后概率掉卡
- [ ] 卡牌翻转动画：不同稀有度不同特效
- [ ] 卡牌图鉴：可查看已收集卡牌
- [ ] 新成就：各条件正确触发
- [ ] 6 个模块战斗均正常
- [ ] 每日挑战不受影响
- [ ] 练习模式不受影响

#### 第二轮：质量测试
- [ ] 控制台无 error
- [ ] 无 timer 泄漏（切换页面后检查）
- [ ] localStorage 异常处理（存储满/损坏）
- [ ] iPad Safari 流畅运行
- [ ] 动画不丢帧（连续快速答题）
- [ ] 粒子数量不超限
- [ ] 内存无持续增长（长时间战斗）

---

## 十、产品经理待确认事项

以下是需要产品经理进一步打磨和确认的内容：

1. **主角形象**：v15 先用固定 emoji 🧙 还是做角色选择系统？
2. **卡牌数量**：143 张卡牌的文案和效果需要逐一设计，工作量较大，是否分两期？
3. **怪物行为难度**：闪避/自爆等行为是否只在 Normal 和 Hard 难度出现？Easy 保持纯净？
4. **对战舞台背景**：6 套主题背景是否需要找参考图先确定风格？
5. **卡牌 SR+ 战斗效果**：是否需要平衡性测试？还是先做纯收集、不带战斗效果？
6. **新怪物故事文案**：37 只新怪物的中英文故事需要文案支持
7. **UR 卡牌的特殊性**：是否需要 UR 卡有特殊的获取方式（比如成就奖励）而不仅是随机掉落？
8. **战斗时间控制**：每题是否加 40 秒倒计时（之前 battle3d 有这个设计）？
9. **舞台背景是否做简单的视差滚动**：增加深度感但会增加复杂度

---

## 附录 A：从 v14.0 PRD 遗留的未完成项

以下是 v14.0 PRD 中规划但未实现的功能，建议在 v15.0 中一并完成：

- [ ] **N01 每日首胜奖励**：首局战斗胜利 +100 分，金色边框高亮
- [ ] **N02 战斗结算展示怪兽**：胜利页显示所有击败怪兽的 emoji
- [ ] **N03 新手引导教学关**：首次进入战斗模式有分步引导
- [ ] **U01 z-index 标准化**：统一 z-index 层级管理
- [ ] **U02 iOS Safe Area 适配**：所有固定元素适配安全区域
- [ ] **U05 iPad 横屏适配**：添加 `@media (min-width: 768px)` 利用大屏

## 附录 B：当前怪物总数

| 模块 | 主题 | Easy | Normal | Hard | Boss | 合计 |
|------|------|------|--------|------|------|------|
| 小九九 | 宝可梦风 | 12 | 20 | 11 | 6 | 49 |
| 分数小数 | 山海经 | ? | ? | ? | ? | ~40 |
| 小数规律 | 西游记 | ? | ? | ? | ? | ~72 |
| 单位换算 | 封神演义 | ? | ? | ? | ? | ~40 |
| 乘法速记 | 聊斋志异 | ? | ? | ? | ? | ~40 |
| 大九九 | 哈利波特 | ? | ? | ? | ? | ~40 |

(具体数量需从各 monster 文件中统计)
