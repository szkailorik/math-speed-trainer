# v16.2 PRD: æˆ˜æ–—åŠ¨ç”»æ‰“ç£¨ + æ™ºèƒ½å‡ºé¢˜ + ä½“éªŒä¿®å¤

> ç‰ˆæœ¬: v16.2 Draft v1
> åŸºç¡€ç‰ˆæœ¬: v16.1 (è¯•ç‚¼ä¹‹å¡” + æ—¶é—´é—ªé¿ + é—ªç°bugä¿®å¤)
> æ—¥æœŸ: 2026-02-10
> çŠ¶æ€: å¼€å‘æ–‡æ¡£

---

## ä¸€ã€ç‰ˆæœ¬ç›®æ ‡

v16.0-16.1 æ­å»ºäº†è¯•ç‚¼ä¹‹å¡”ã€ä¸»è§’å¤šå±‚ç³»ç»Ÿã€è¿å‡»ç³»ç»Ÿ2.0ã€æ€ªç‰©è¡Œä¸º2.0 çš„ä»£ç æ¡†æ¶ï¼Œä½†å®é™…æˆ˜æ–—ä½“éªŒä»æœ‰ä¸‰ä¸ªæ ¸å¿ƒç—›ç‚¹ï¼š

1. **æ”»å‡»åŠ¨ç”»"æ— æºæ„Ÿ"**ï¼šæ­¦å™¨å‡­ç©ºé£å‡ºï¼Œä¸»è§’å’Œæ€ªç‰©éƒ½æ²¡æœ‰æŒ¥åŠ¨/æ–½æ”¾åŠ¨ä½œï¼Œæ‰“å‡»æ„Ÿä¸è¶³
2. **å‡ºé¢˜æœºåˆ¶"ä¸€åˆ€åˆ‡"**ï¼šæ‰€æœ‰é¢˜ç›®ç­‰æ¦‚ç‡å‡ºç°ï¼Œåšé”™çš„é¢˜ä¸ä¼šå¼ºåŒ–å¤ä¹ ï¼Œç»ƒä¹ æ•ˆæœæ‰“æŠ˜
3. **ä½“éªŒbugæœªæ ¹æ²»**ï¼šè¿›å…¥æ–°å…³å¡æ—¶é¢˜ç›®é—ªç°ã€ç­”é¢˜æ— å€’è®¡æ—¶å‹è¿«æ„Ÿ

v16.2 çš„æ ¸å¿ƒç›®æ ‡ï¼š**æŠŠ"èƒ½ç”¨"å˜æˆ"å¥½ç”¨"**ã€‚

| ä¼˜å…ˆçº§ | æ”¹åŠ¨é¡¹ | ç”¨æˆ·ä»·å€¼ |
|--------|--------|----------|
| P0 | æ”»å‡»åŠ¨ç”»å…¨é¢å‡çº§ | æ¯æ¬¡ç­”é¢˜éƒ½æœ‰å®Œæ•´çš„"å‡†å¤‡â†’æŒ¥å‡»â†’æŠ•å°„â†’å‘½ä¸­"æ¼”å‡º |
| P0 | é¢˜ç›®é—ªç°bugæ ¹æ²» | è¿›å…¥æ–°å…³å¡ä¸å†çœ‹åˆ°æ®‹ç•™é¢˜ç›®é—ªçƒ |
| P1 | æˆ˜æ–—å€’è®¡æ—¶ + é—ªé¿è”åŠ¨ | ç­”é¢˜æœ‰ç´§è¿«æ„Ÿï¼Œé—ªé¿æœºåˆ¶å¯è§†åŒ– |
| P1 | æ™ºèƒ½å‡ºé¢˜ç³»ç»Ÿ | åšé”™çš„é¢˜è‡ªåŠ¨æé¢‘ï¼Œè–„å¼±ç¯èŠ‚æŒç»­å¼ºåŒ– |
| P2 | è¿å‡»æ”»å‡»ç³»ç»Ÿé›†æˆ | hero-system.js çš„5é˜¶æ®µæ”»å‡»æ¥å…¥ä¸»æˆ˜æ–—æµç¨‹ |

---

## äºŒã€æ ¸å¿ƒæ”¹åŠ¨ä¸€ï¼šæ”»å‡»åŠ¨ç”»å…¨é¢å‡çº§ï¼ˆP0ï¼‰

### 2.1 å½“å‰é—®é¢˜åˆ†æ

**ä»£ç ç°çŠ¶å‘ç°äº†ä¸¤å¥—å¹¶è¡Œæ”»å‡»ç³»ç»Ÿï¼š**

| ç³»ç»Ÿ | æ–‡ä»¶ | è§¦å‘åœºæ™¯ | åŠ¨ç”»æ–¹å‘ |
|------|------|----------|----------|
| æ—§ç³»ç»Ÿ `fireWeapon()` | battle-combat.js:1093 | `handleCorrectAnswer` ä¸»æµç¨‹ | ä»é¢˜ç›®åŒºåŸŸ**å‚ç›´å‘ä¸Š**é£ |
| æ–°ç³»ç»Ÿ `fireWeaponHorizontal()` | battle-arena.js:304 | ä»…åœ¨ `heroAttackAnimation`(é—ªé¿è·¯å¾„) | åœ¨æˆ˜æ–—èˆå°**æ°´å¹³å‘å³**é£ |
| è¿å‡»ç³»ç»Ÿ `executeComboAttack()` | hero-system.js:218-531 | **æœªæ¥å…¥ä¸»æµç¨‹ï¼** | æœ‰5ç§å®Œæ•´æ”»å‡»æ¼”å‡º |

**é—®é¢˜æ¸…å•ï¼š**

1. ä¸»è§’**ç­”å¯¹æ—¶**ï¼šåªè§¦å‘ `setHeroState('cast_spell')`ï¼ˆæ”¾å¤§0.3ç§’ï¼‰+ æ—§ç‰ˆå‚ç›´ `fireWeapon`ã€‚ä¸»è§’æ²¡æœ‰æŒ¥åŠ¨æ­¦å™¨çš„åŠ¨ä½œï¼Œæ­¦å™¨å‡­ç©ºä»é¢˜ç›®åŒºé£å‡ºã€‚
2. æ€ªç‰©**æ”»å‡»æ—¶**ï¼šåªæœ‰ä¸€ä¸ªæŠ•å°„ç‰©ä»å³é£åˆ°å·¦ï¼ˆ`enemyAttackAnimation`ï¼‰ï¼Œæ€ªç‰©æœ¬èº«åªæ˜¯çŸ­æš‚å‘å·¦å†²äº†40pxã€‚æ²¡æœ‰"è“„åŠ›â†’å‡ºæ‹›"çš„é¢„å¤‡åŠ¨ä½œã€‚
3. `hero-system.js` å®šä¹‰äº†å®Œæ•´çš„5é˜¶æ®µæ”»å‡»ï¼ˆnormalâ†’doubleâ†’tripleâ†’chargedâ†’ultimateï¼‰ï¼Œä½† `handleCorrectAnswer` çš„ä¸»è·¯å¾„**ä»æœªè°ƒç”¨** `executeComboAttack()`ã€‚
4. æ—§ç‰ˆå‚ç›´ `fireWeapon` å’Œç¬¬ä¸‰äººç§°æ°´å¹³èˆå°è§†è§’**ä¸åè°ƒ**â€”â€”æ­¦å™¨ä¸åº”è¯¥ä»å±å¹•ä¸‹æ–¹å‘ä¸Šé£ã€‚

### 2.2 ç›®æ ‡æ–¹æ¡ˆï¼šç»Ÿä¸€æ”»å‡»æµæ°´çº¿

#### 2.2.1 ä¸»è§’æ”»å‡»æµç¨‹ï¼ˆç­”å¯¹åï¼‰

åºŸå¼ƒæ—§ç‰ˆ `fireWeapon()`ï¼Œç»Ÿä¸€èµ°æ–°çš„æ”»å‡»æµæ°´çº¿ï¼š

```
ç­”å¯¹ â†’ â‘  ä¸»è§’ä¸¾èµ·æ­¦å™¨ï¼ˆå‡†å¤‡ 0.2sï¼‰
     â†’ â‘¡ ä¸»è§’æŒ¥åŠ¨æ­¦å™¨ï¼ˆæŒ¥å‡» 0.3sï¼‰
     â†’ â‘¢ æ­¦å™¨/æ³•æœ¯æŠ•å°„ç‰©ä»ä¸»è§’é£å‘æ€ªç‰©ï¼ˆé£è¡Œ 0.4sï¼‰
     â†’ â‘£ æ€ªç‰©å—å‡»åé¦ˆï¼ˆé—ªç™½+å¼¹é€€ 0.3sï¼‰
     â†’ â‘¤ ä¼¤å®³æ•°å­—å¼¹å‡º

æ€»æ—¶é•¿: ~1.2sï¼ˆè¿å‡»é«˜æ—¶ç¼©çŸ­åˆ° ~0.8s æå‡èŠ‚å¥æ„Ÿï¼‰
```

**â‘  å‡†å¤‡é˜¶æ®µ (0.2s)**
- ä¸»è§’æ­¦å™¨å±‚ï¼ˆ`.hero-weapon-layer`ï¼‰ä»é»˜è®¤ä½ç½®ç§»åŠ¨åˆ°"ä¸¾èµ·"ä½ç½®
- æ­¦å™¨å‘ä¸Šåç§» + è½»å¾®æ—‹è½¬ï¼Œæš—ç¤ºè“„åŠ›
- CSS: `@keyframes weapon-raise { to { transform: translateY(-15px) rotate(-30deg) } }`

**â‘¡ æŒ¥å‡»é˜¶æ®µ (0.3s)**
- ä¸»è§’è§’è‰²å±‚å‘å³å†²åˆº 20pxï¼ˆ`hero-swing`ï¼‰
- æ­¦å™¨å±‚åŒæ—¶åšå¼§çº¿æŒ¥å‡»åŠ¨ç”»ï¼ˆä»å·¦ä¸Šâ†’å³ä¸‹çš„å¼§å½¢è½¨è¿¹ï¼‰
- CSS: `@keyframes weapon-swing { from { rotate(-30deg) } to { rotate(45deg) translateX(20px) } }`
- æŒ¥å‡»æœ«å°¾äº§ç”Ÿä¸€é“å¼§å½¢åˆ€å…‰/æ³•æœ¯å…‰ï¼ˆSVG æˆ– CSS clip-path å®ç°çš„å¼§çº¿ï¼‰

**â‘¢ æŠ•å°„é£è¡Œ (0.4s)**
- æŠ•å°„ç‰©ä»ä¸»è§’ä½ç½®æ°´å¹³é£å‘æ€ªç‰©
- ç»Ÿä¸€ä½¿ç”¨ `fireWeaponHorizontal()` çš„æ”¹è¿›ç‰ˆ
- æŠ•å°„ç‰©å¸¦æ‹–å°¾ç²’å­ï¼ˆé¢œè‰²ä¸æ­¦å™¨åŒ¹é…ï¼‰
- è¿å‡» â‰¥5 æ—¶æŠ•å°„ç‰©æ”¾å¤§ 1.3x + æ›´å¯†é›†ç²’å­

**â‘£ å‘½ä¸­åé¦ˆ (0.3s)**
- æ€ªç‰© `enemy-hit-arena` åŠ¨ç”»ï¼ˆå·²æœ‰ï¼Œä¿æŒä¸å˜ï¼‰
- å‘½ä¸­ç¬é—´å±å¹•å¾®éœ‡ï¼ˆ`shake-light`ï¼‰
- é«˜è¿å‡»æ—¶å‘½ä¸­ç‰¹æ•ˆå¢å¼ºï¼ˆæ›´å¤§ä¼¤å®³æ•°å­—ã€æ›´å¤šç²’å­ï¼‰

**â‘¤ ä¼¤å®³æ•°å­—**
- å·²æœ‰ï¼Œä¿æŒä¸å˜

#### 2.2.2 æ€ªç‰©æ”»å‡»æµç¨‹ï¼ˆç­”é”™åï¼‰

```
ç­”é”™ â†’ â‘  æ€ªç‰©è“„åŠ›/å¨å“ï¼ˆ0.5sï¼‰
     â†’ â‘¡ æ€ªç‰©å†²åˆº + é‡Šæ”¾æ”»å‡»ï¼ˆ0.4sï¼‰
     â†’ â‘¢ æ”»å‡»æŠ•å°„ç‰©ä»æ€ªç‰©é£å‘ä¸»è§’ï¼ˆ0.4sï¼‰
     â†’ â‘£ ä¸»è§’å—å‡»ï¼ˆé—ªçº¢+å¼¹é€€ 0.4sï¼‰+ å±å¹•é—ªçº¢
     â†’ â‘¤ æ‰£è¡€åŠ¨ç”»

æ€»æ—¶é•¿: ~1.7s
```

**â‘  è“„åŠ›é˜¶æ®µ (0.5s)** â€” æ–°å¢
- æ€ªç‰©æ”¾å¤§ 1.15x + æ˜¾ç¤ºæ”»å‡»é¢„å¤‡åŠ¨ä½œ
- æ€ªç‰©ä¸Šæ–¹æ˜¾ç¤ºæ”»å‡»åç§°æ°”æ³¡ï¼ˆå·²æœ‰ `showAttackName`ï¼Œè°ƒæ•´æ—¶åºåˆ°è¿™é‡Œï¼‰
- æ€ªç‰© emoji è½»å¾®æŠ–åŠ¨ï¼ˆè“„åŠ›æ„Ÿï¼‰
- CSS: `@keyframes enemy-charge { 0% { scale(1) } 50% { scale(1.15) } 100% { scale(1.1) } }`

**â‘¡ å†²åˆº+é‡Šæ”¾ (0.4s)**
- æ€ªç‰©å‘å·¦å†²åˆº 50pxï¼ˆå½“å‰40pxï¼Œç•¥å¢ï¼‰
- å†²åˆºæœ«å°¾é‡Šæ”¾æ”»å‡»æŠ•å°„ç‰©
- CSS: å¤ç”¨ `enemy-attack-arena` å¹¶å¢åŠ å†²åˆºè·ç¦»

**â‘¢ æŠ•å°„é£è¡Œ (0.4s)**
- æ”»å‡» emoji ä»æ€ªç‰©ä½ç½®é£å‘ä¸»è§’ï¼ˆå·²æœ‰ï¼Œä¿æŒä¸å˜ï¼‰

**â‘£ ä¸»è§’å—å‡» (0.4s)**
- `hero-hit` åŠ¨ç”»ï¼ˆå·²æœ‰ï¼‰+ å±å¹•é—ªçº¢ï¼ˆå·²æœ‰ï¼‰

#### 2.2.3 è¿å‡»æ”»å‡»ç³»ç»Ÿé›†æˆï¼ˆP2ï¼‰

å°† `hero-system.js` ä¸­å·²å®šä¹‰çš„ 5 é˜¶æ®µæ”»å‡»ç³»ç»Ÿæ¥å…¥ `handleCorrectAnswer`ï¼š

| è¿å‡»é˜¶æ®µ | combo èŒƒå›´ | æ”»å‡»æ–¹æ³• | æ­¦å™¨ | ç‰¹æ•ˆ |
|----------|-----------|----------|------|------|
| normal | 0-2 | `attackNormal` | æ¨¡å—é»˜è®¤æ­¦å™¨ | æ—  |
| awakened | 3-4 | `attackDouble` | ğŸ”¥ | åŒè¿å‡» + ç«ç„°æ‹–å°¾ |
| will | 5-9 | `attackTriple` | âš¡ | ä¸‰è¿æ–© + é—ªç”µå¼§ |
| godlike | 10-14 | `attackCharged` | ğŸ’ | è“„åŠ›é‡å‡» + å±å¹•æš—åŒ– |
| invincible | 15+ | `attackUltimate` | ğŸŒŸ | ç»ˆç»“æŠ€ + å…¨å±ç‰¹æ•ˆ |

**æ¥å…¥æ–¹å¼ï¼š** åœ¨ `handleCorrectAnswer` ä¸­ï¼Œæ›¿æ¢å½“å‰çš„ `setHeroState('cast_spell') + fireWeapon()` ä¸ºï¼š

```javascript
// æ›¿æ¢å‰ï¼ˆå½“å‰ä»£ç  battle-combat.js:804-806ï¼‰
this.setHeroState('cast_spell');
this.fireWeapon(weapon, damage);

// æ›¿æ¢å
this.executeComboAttack(weapon, damage, () => {
    this.dealDamage(damage);
    // ...heal, dropItem logic
});
```

`executeComboAttack` æ ¹æ® `App.battle.comboStage` è‡ªåŠ¨é€‰æ‹©æ”»å‡»æ–¹æ³•ï¼Œæ’­æ”¾å®Œæ•´åŠ¨ç”»åºåˆ—åå›è°ƒã€‚

**æ—¶åºå…¼å®¹ï¼š** å½“å‰ `dealDamage` åœ¨ `setTimeout(400)` åè°ƒç”¨ï¼Œæ›¿æ¢ä¸ºå›è°ƒé©±åŠ¨åï¼Œ`dealDamage` åœ¨æ”»å‡»åŠ¨ç”»å®Œæˆæ—¶æ‰è°ƒç”¨ï¼Œä¸å†éœ€è¦ç¡¬ç¼–ç å»¶è¿Ÿã€‚

### 2.3 å®ç°è¦ç‚¹

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `battle-combat.js` | `handleCorrectAnswer`: æ›¿æ¢ fireWeapon â†’ executeComboAttack å›è°ƒé“¾; `handleWrongAnswer`: å¢åŠ æ€ªç‰©è“„åŠ›é˜¶æ®µ; åˆ é™¤æ—§ `fireWeapon()` |
| `battle-arena.js` | æ”¹è¿› `heroAttackAnimation`: å¢åŠ æ­¦å™¨ä¸¾èµ·+æŒ¥å‡»é˜¶æ®µ; æ”¹è¿› `enemyAttackAnimation`: å¢åŠ è“„åŠ›é˜¶æ®µ; `fireWeaponHorizontal`: å¢åŠ æ‹–å°¾ç²’å­ |
| `hero-system.js` | `executeComboAttack`: ç¡®ä¿æ­£ç¡®æ¥å…¥ dealDamage å›è°ƒ; å„æ”»å‡»æ–¹æ³•å¾®è°ƒæ—¶åºï¼ˆnormal ä¸è¶…è¿‡ 0.8sï¼‰ |
| `style.css` | æ–°å¢: `weapon-raise`, `weapon-swing`, `enemy-charge` åŠ¨ç”»; è°ƒæ•´æŠ•å°„ç‰©æ ·å¼ |
| `index.html` | åˆ é™¤æ—§çš„ `#weapon-area` divï¼ˆä¸å†éœ€è¦å‚ç›´é£è¡Œå®¹å™¨ï¼‰ |

#### CSS åŠ¨ç”»æ–°å¢æ¸…å•

```css
/* æ­¦å™¨ä¸¾èµ· */
@keyframes weapon-raise { ... }

/* æ­¦å™¨æŒ¥å‡»å¼§çº¿ */
@keyframes weapon-swing { ... }

/* æŒ¥å‡»åˆ€å…‰/æ³•æœ¯å¼§ */
@keyframes slash-arc { ... }

/* æ€ªç‰©è“„åŠ› */
@keyframes enemy-charge { ... }

/* æŠ•å°„ç‰©å¢å¼ºæ‹–å°¾ï¼ˆç²’å­é€šè¿‡ JS åˆ›å»ºï¼‰ */
.projectile-trail { ... }
```

---

## ä¸‰ã€æ ¸å¿ƒæ”¹åŠ¨äºŒï¼šé¢˜ç›®é—ªç°bugæ ¹æ²»ï¼ˆP0ï¼‰

### 3.1 æ ¹å› åˆ†æ

**ç»è¿‡ä»£ç æ·±åº¦å®¡æŸ¥ï¼Œç¡®è®¤äº†é—ªç°çš„æ ¹æœ¬åŸå› ï¼š**

#### åŸå› 1ï¼šå…³å¡åˆ‡æ¢æ—¶æ—§é¢˜ç›®æ®‹ç•™ï¼ˆä¸»å› ï¼‰

`initStage()` çš„æ—¶åºï¼š

```
t=0ms:    showStageTransition() â€” å…¨å±é®ç½©æ˜¾ç¤º
t=1200ms: é®ç½©æ¶ˆå¤±
t=1500ms: enemyEnterAnimation å¼€å§‹
t=3300ms: showBattleQuestion() â€” æ–°é¢˜ç›®æ˜¾ç¤º
```

**é—®é¢˜ï¼šä» t=1200msï¼ˆé®ç½©æ¶ˆå¤±ï¼‰åˆ° t=3300msï¼ˆæ–°é¢˜ç›®å‡ºç°ï¼‰ï¼Œæœ‰ 2100ms çš„ç©ºçª—æœŸã€‚è¿™æ®µæ—¶é—´å†…ï¼Œä¸Šä¸€å…³æœ€åä¸€é“é¢˜çš„æ–‡å­—ä»æ˜¾ç¤ºåœ¨ `#battle-question-text` ä¸­ï¼Œç”¨æˆ·èƒ½çœ‹åˆ°æ—§é¢˜ç›®ã€‚**

å½“æ–°é¢˜ç›®å‡ºç°æ—¶ï¼Œæ–‡å­—åˆ‡æ¢é€ æˆ"é—ªç°"æ„Ÿã€‚

#### åŸå› 2ï¼šè¡Œä¸ºåŠ¨ç”»å›è°ƒé“¾ä¸­çš„ç«æ€

`dealDamage()` ä¸­ï¼Œå¦‚æœåŒæ—¶è§¦å‘ hpThreshold è¡Œä¸ºå’Œ turnInterval è¡Œä¸ºï¼ŒåµŒå¥—çš„ `executeBehavior` å›è°ƒé“¾å¯èƒ½åœ¨è¡Œä¸ºåŠ¨ç”»æœªå®Œæˆæ—¶å°±è§¦å‘å›è°ƒï¼Œå¯¼è‡´ä¸¤ä¸ª `showBattleQuestion()` å‡ ä¹åŒæ—¶è¢«è°ƒåº¦ã€‚

#### åŸå› 3ï¼šv16.1 ä¿®å¤æœªè¦†ç›–æˆ˜æ–—æ¨¡å¼

v16.1 ä¿®å¤äº†ç»ƒä¹ æ¨¡å¼çš„è®¡æ—¶å™¨ç«æ€ï¼Œä½†æˆ˜æ–—æ¨¡å¼çš„ `showBattleQuestion()` æ²¡æœ‰é˜²é‡å…¥ä¿æŠ¤ã€‚å¦‚æœä¸¤ä¸ª setTimeout åŒæ—¶è°ƒåº¦ `showBattleQuestion()`ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ˜¾ç¤ºé¢˜ç›®Aï¼Œç¬¬äºŒæ¬¡è°ƒç”¨ç«‹å³æ›¿æ¢ä¸ºé¢˜ç›®Bï¼Œç”¨æˆ·çœ‹åˆ°é¢˜ç›®Aé—ªç°åå˜æˆé¢˜ç›®Bã€‚

### 3.2 ä¿®å¤æ–¹æ¡ˆ

#### ä¿®å¤1ï¼šinitStage æ¸…ç©ºæ—§é¢˜ç›® + éšè—ç­”é¢˜åŒº

åœ¨ `initStage()` å¼€å§‹æ—¶ï¼š

```javascript
// æ¸…ç©ºæ—§é¢˜ç›®å†…å®¹
document.getElementById('battle-question-text').textContent = '';
// éšè—ç­”é¢˜åŒºï¼ˆé€‰é¡¹æŒ‰é’®ï¼‰ç›´åˆ° showBattleQuestion
document.getElementById('battle-choices').innerHTML = '';
document.getElementById('battle-question-card').style.opacity = '0';
```

åœ¨ `showBattleQuestion()` ä¸­æ¢å¤ï¼š

```javascript
document.getElementById('battle-question-card').style.opacity = '1';
```

#### ä¿®å¤2ï¼šshowBattleQuestion åŠ é˜²é‡å…¥é”

```javascript
var _questionDisplayPending = false;

BattleMode.showBattleQuestion = function() {
    // é˜²æ­¢é‡å¤è°ƒç”¨
    if (_questionDisplayPending) return;
    _questionDisplayPending = true;

    // ... é¢˜ç›®æ˜¾ç¤ºé€»è¾‘ ...

    // é‡ç½®é˜²é‡å…¥é”ï¼ˆåœ¨æŒ‰é’®æ¸²æŸ“å®Œæˆåï¼‰
    setTimeout(() => { _questionDisplayPending = false; }, 50);
};
```

#### ä¿®å¤3ï¼šå»¶é•¿é®ç½©åˆ°å…¥åœºåŠ¨ç”»è¡”æ¥

å°† `showStageTransition` çš„é®ç½©æ—¶é•¿ä» 1200ms å»¶é•¿åˆ° 1500msï¼Œä¸ `enemyEnterAnimation` çš„ setTimeout æ— ç¼è¡”æ¥ï¼š

```javascript
// å½“å‰ï¼šé®ç½© 1200msï¼Œå…¥åœº 1500ms â†’ 300ms ç©ºçª—
// ä¿®å¤ï¼šé®ç½© 1500msï¼Œå…¥åœº 1500ms â†’ 0ms ç©ºçª—
setTimeout(() => transition.classList.remove('show'), 1500);
```

---

## å››ã€æ ¸å¿ƒæ”¹åŠ¨ä¸‰ï¼šæˆ˜æ–—å€’è®¡æ—¶ + é—ªé¿è”åŠ¨ï¼ˆP1ï¼‰

### 4.1 éœ€æ±‚åˆ†æ

v16.1 å®ç°äº†"ç­”é¢˜æ—¶é—´è¶…è¿‡é˜ˆå€¼è§¦å‘é—ªé¿"ï¼Œä½†ç©å®¶çœ‹ä¸åˆ°å€’è®¡æ—¶ï¼Œä¸çŸ¥é“è‡ªå·±è¿˜æœ‰å¤šå°‘æ—¶é—´ï¼Œé—ªé¿çš„è§¦å‘æ˜¾å¾—"çªç„¶"ã€‚

**ç›®æ ‡ï¼š** åœ¨æˆ˜æ–—é¢˜ç›®åŒºåŸŸæ·»åŠ å¯è§†åŒ–å€’è®¡æ—¶æ¡ï¼Œè®©ç©å®¶æ˜ç¡®çŸ¥é“æ—¶é—´é™åˆ¶ã€‚

### 4.2 å€’è®¡æ—¶è®¾è®¡

#### 4.2.1 æ—¶é—´é˜ˆå€¼è®¨è®º

é€Ÿç®—è®­ç»ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯**åŸ¹å…»æ¡ä»¶åå°„**ï¼Œä¸æ˜¯ç»™æ—¶é—´æ…¢æ…¢æƒ³ã€‚å‚è€ƒæ ‡å‡†ï¼š

| ç†Ÿç»ƒåº¦ | ç®€å•é¢˜ï¼ˆå¦‚ 3Ã—4ï¼‰ | ä¸­ç­‰é¢˜ï¼ˆå¦‚ 25Ã—4ï¼‰ | éœ€è¦æ¨å¯¼çš„é¢˜ |
|--------|-----------------|------------------|-------------|
| æ¡ä»¶åå°„ | < 1s | 1-2s | 2-3s |
| åŸºæœ¬ç†Ÿç»ƒ | 1-2s | 2-3s | 3-5s |
| åˆå­¦è€… | 2-3s | 3-5s | 5-8s |

**ç»“è®ºï¼šå€’è®¡æ—¶å¿…é¡»çŸ­ï¼Œæ‰èƒ½é€¼å‡ºç†Ÿç»ƒåº¦ã€‚**

| éš¾åº¦ | å€’è®¡æ—¶æ—¶é—´ | å±é™©åŒº | é—ªé¿è§¦å‘ | è¶…æ—¶ |
|------|-----------|--------|----------|------|
| Easy | **5ç§’** | æœ€å1.5ç§’ | å±é™©åŒºå†…ç­”å¯¹ â†’ 50%é—ªé¿ | è¶…æ—¶ â†’ è‡ªåŠ¨åˆ¤é”™ |
| Normal | **3ç§’** | æœ€å1.5ç§’ | å±é™©åŒºå†…ç­”å¯¹ â†’ 50%é—ªé¿ | è¶…æ—¶ â†’ è‡ªåŠ¨åˆ¤é”™ |
| Hard | **2ç§’** | æœ€å1.5ç§’ | å±é™©åŒºå†…ç­”å¯¹ â†’ 60%é—ªé¿ | è¶…æ—¶ â†’ è‡ªåŠ¨åˆ¤é”™ |

> **è®¾è®¡ç†å¿µï¼šè¿™æ˜¯é€Ÿç®—è®­ç»ƒï¼Œç›®æ ‡æ˜¯åŸ¹å…»æ¡ä»¶åå°„å¼çš„å¿ƒç®—èƒ½åŠ›ã€‚**
> - Easy 5ç§’ï¼šç»™åˆå­¦è€…è¶³å¤Ÿååº”æ—¶é—´ï¼Œä½†ä¹Ÿä¸èƒ½æ…¢æ‚ æ‚ 
> - Normal 3ç§’ï¼šä¸­ç­‰ç†Ÿç»ƒåº¦ï¼Œ3ç§’å†…å¿…é¡»å‡ºç­”æ¡ˆ
> - Hard 2ç§’ï¼šé€¼è¿‘æ¡ä»¶åå°„æé™ï¼Œä¸å‡æ€ç´¢æ‰èƒ½é€šå…³
> - Hard æ¨¡å¼çš„2ç§’ä¸­æœ‰1.5ç§’æ˜¯å±é™©åŒºâ€”â€”ç­‰äºä¸€å‡ºé¢˜å°±è¿›å…¥å‹åŠ›çŠ¶æ€ï¼Œå¿…é¡»ç§’ç­”

**é—ªé¿æœºåˆ¶æ”¹è¿›ï¼š**
- å€’è®¡æ—¶æ¡ä»ç»¿è‰²â†’é»„è‰²â†’çº¢è‰²æ¸å˜
- è¿›å…¥"å±é™©åŒº"ï¼ˆæœ€å1.5ç§’ï¼‰æ—¶ï¼Œå€’è®¡æ—¶æ¡é—ªçƒ + æ€ªç‰©åšå‡ºå‡†å¤‡é—ªé¿çš„å¾®åŠ¨ä½œï¼ˆè½»å¾®å·¦å³æ™ƒåŠ¨ï¼‰
- åœ¨å±é™©åŒºå†…ç­”å¯¹ï¼šæ€ªç‰©æœ‰æ¦‚ç‡é—ªé¿ï¼ˆEasy/Normal 50%, Hard 60%ï¼‰
- è¶…æ—¶æœªç­”ï¼šè§†ä¸ºç­”é”™ï¼Œæ€ªç‰©ç›´æ¥æ”»å‡»
- å±é™©åŒºä¹‹å‰ç­”å¯¹ï¼šæ­£å¸¸å‘½ä¸­ï¼Œæ— é—ªé¿

**å…³é”®èŠ‚å¥æ„Ÿï¼š**
- Easy 5ç§’ï¼šå‰3.5ç§’å®‰å…¨ â†’ æœ€å1.5ç§’å±é™©
- Normal 3ç§’ï¼šå‰1.5ç§’å®‰å…¨ â†’ æœ€å1.5ç§’å±é™©ï¼ˆä¸€åŠæ—¶é—´æ˜¯å®‰å…¨åŒºï¼Œä¸€åŠæ˜¯å±é™©åŒºï¼‰
- Hard 2ç§’ï¼šå‰0.5ç§’å®‰å…¨ â†’ æœ€å1.5ç§’å±é™©ï¼ˆå‡ ä¹å…¨ç¨‹é«˜å‹ï¼‰

**ä¸ v16.1 çš„åŒºåˆ«ï¼š**
v16.1 ç”¨å›ºå®šé˜ˆå€¼ï¼ˆeasy:8s, normal:5s, hard:3sï¼‰ï¼Œæ²¡æœ‰å¯è§†åŒ–ï¼Œæ—¶é—´å¤ªé•¿ã€‚v16.2 å¤§å¹…ç¼©çŸ­åˆ°çœŸå®é€Ÿç®—èŠ‚å¥ï¼ˆ5/3/2ç§’ï¼‰ï¼Œé…åˆå¯è§†åŒ–å€’è®¡æ—¶æ¡ï¼Œè®©é—ªé¿æœºåˆ¶æˆä¸º"å¿«å°±èµ¢ã€æ…¢å°±äº"çš„æ ¸å¿ƒç´§è¿«æ„Ÿæ¥æºã€‚

#### 4.2.2 UI è®¾è®¡

åœ¨ `#battle-question-card` å†…éƒ¨æ·»åŠ å€’è®¡æ—¶æ¡ï¼š

```html
<div class="battle-timer-bar" id="battle-timer-bar">
    <div class="battle-timer-progress" id="battle-timer-progress"></div>
</div>
```

å€’è®¡æ—¶æ¡æ ·å¼ï¼š
- ä½äºé¢˜ç›®å¡ç‰‡é¡¶éƒ¨ï¼Œç»†æ¡ï¼ˆ3pxé«˜ï¼‰
- é¢œè‰²æ¸å˜ï¼šç»¿è‰²(>60%) â†’ é»„è‰²(30-60%) â†’ çº¢è‰²(<30%)
- è¿›å…¥å±é™©åŒºæ—¶ï¼šæ¡å˜ç²—ï¼ˆ5pxï¼‰+ è„‰å†²é—ªçƒ

#### 4.2.3 å®ç°é€»è¾‘

```javascript
BattleMode.startBattleTimer = function() {
    const battle = App.battle;
    const duration = battle.difficulty === 'easy' ? 5000 :
                     battle.difficulty === 'hard' ? 2000 : 3000;
    const dangerZone = 1500; // ç»Ÿä¸€1.5ç§’å±é™©åŒº

    battle.timerStartTime = Date.now();
    battle.timerDuration = duration;
    battle.timerDangerZone = dangerZone;
    battle.inDangerZone = false;

    const bar = document.getElementById('battle-timer-progress');

    battle.battleTimerInterval = setInterval(() => {
        if (_battleAnswerLocked) {
            clearInterval(battle.battleTimerInterval);
            return;
        }

        const elapsed = Date.now() - battle.timerStartTime;
        const remaining = Math.max(0, 1 - elapsed / duration);
        bar.style.width = (remaining * 100) + '%';

        // é¢œè‰²æ¸å˜
        if (remaining > 0.6) bar.className = 'battle-timer-progress timer-safe';
        else if (remaining > 0.3) bar.className = 'battle-timer-progress timer-warning';
        else bar.className = 'battle-timer-progress timer-danger';

        // å±é™©åŒºè§¦å‘
        if (elapsed >= duration - dangerZone && !battle.inDangerZone) {
            battle.inDangerZone = true;
            BattleMode.setEnemyState('dodge-ready'); // æ€ªç‰©å‡†å¤‡é—ªé¿å¾®åŠ¨ä½œ
        }

        // è¶…æ—¶
        if (remaining <= 0) {
            clearInterval(battle.battleTimerInterval);
            if (!_battleAnswerLocked) {
                _battleAnswerLocked = true;
                BattleMode.handleTimeoutAnswer();
            }
        }
    }, 50);
};
```

åœ¨ `showBattleQuestion()` æœ«å°¾è°ƒç”¨ `this.startBattleTimer()`ã€‚

`handleTimeoutAnswer()` æ–°å¢æ–¹æ³•ï¼š
- æ˜¾ç¤º"â±ï¸ è¶…æ—¶ï¼"åé¦ˆ
- è§†ä¸ºç­”é”™ï¼Œè§¦å‘æ€ªç‰©æ”»å‡»
- è®°å…¥é”™é¢˜æœ¬ï¼ˆyourAnswer æ ‡è®°ä¸ºè¶…æ—¶ï¼‰

é—ªé¿åˆ¤å®šæ”¹è¿›ï¼ˆæ›¿æ¢ v16.1 çš„ `_checkBehaviorCondition` dodge é€»è¾‘ï¼‰ï¼š

```javascript
case 'dodge':
    if (phase !== 'afterCorrect') return false;
    if (battle.dodged) return false;
    // åªåœ¨å±é™©åŒºå†…ç­”å¯¹æ—¶è§¦å‘é—ªé¿
    if (!battle.inDangerZone) return false;
    var dodgeChance = battle.difficulty === 'hard' ? 0.6 : 0.5; // Hard 60%, å…¶ä½™ 50%
    return Math.random() < dodgeChance;
```

---

## äº”ã€æ ¸å¿ƒæ”¹åŠ¨å››ï¼šæ™ºèƒ½å‡ºé¢˜ç³»ç»Ÿï¼ˆP1ï¼‰

### 5.1 å½“å‰é—®é¢˜

**æ‰€æœ‰é¢˜ç›®ç­‰æ¦‚ç‡å‡ºç°ï¼Œæ²¡æœ‰ä»»ä½•æ™ºèƒ½è°ƒåº¦ï¼š**
- ç»ƒä¹ æ¨¡å¼ï¼š`shuffle(questions).slice(0, count)` â€” çº¯éšæœº
- æˆ˜æ–—æ¨¡å¼ï¼š`shuffle(diffData)` + warmup ç©¿æ’ â€” çº¯éšæœº
- åšé”™çš„é¢˜ä¸ä¼šå†æ¬¡å‡ºç°ï¼Œé™¤éæ‰‹åŠ¨è¿›å…¥"é”™é¢˜æœ¬ç»ƒä¹ "
- æ²¡æœ‰è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿æˆ–é—´éš”é‡å¤æœºåˆ¶

### 5.2 ç›®æ ‡æ–¹æ¡ˆï¼šåŠ æƒå‡ºé¢˜ + é”™é¢˜å¼ºåŒ–

#### 5.2.1 é¢˜ç›®æƒé‡ç³»ç»Ÿ

ä¸ºæ¯é“é¢˜ç»´æŠ¤ä¸€ä¸ªåŠ¨æ€æƒé‡ï¼Œå½±å“è¢«é€‰ä¸­çš„æ¦‚ç‡ï¼š

```javascript
// æ–°å¢ App.questionWeights å¯¹è±¡ï¼ˆæŒ‰æ¨¡å—+é¢˜ç›®æ–‡æœ¬ç´¢å¼•ï¼‰
App.questionWeights = {
    // key: "module:questionText", value: { weight, wrongCount, lastWrong, lastCorrect }
    "xiaojiujiu:3Ã—7": { weight: 1.0, wrongCount: 0, lastWrong: null, lastCorrect: null },
    "multiply:25Ã—4":  { weight: 3.0, wrongCount: 2, lastWrong: 1707600000, lastCorrect: null },
    // ...
};
```

#### 5.2.2 æƒé‡è®¡ç®—è§„åˆ™

åŸºç¡€æƒé‡ = 1.0ï¼Œé€šè¿‡ä»¥ä¸‹è§„åˆ™è°ƒæ•´ï¼š

| äº‹ä»¶ | æƒé‡å˜åŒ– | è¯´æ˜ |
|------|----------|------|
| ç­”é”™ 1 æ¬¡ | +1.5 | é”™ 1 æ¬¡çš„é¢˜æƒé‡ = 2.5 |
| ç­”é”™ 2 æ¬¡ | +2.5 | ç´¯ç§¯åˆ° 4.0 |
| ç­”é”™ 3+ æ¬¡ | +3.0 | æœ€é«˜ç´¯ç§¯åˆ° 5.0 |
| è¢«æ€ªç‰©æ”»å‡»ï¼ˆæˆ˜æ–—ä¸­ç­”é”™ï¼‰ | é¢å¤– +0.5 | æˆ˜æ–—ä¸­ç­”é”™å°è±¡æ›´æ·± |
| ç­”å¯¹ 1 æ¬¡ | -0.3 | é€æ­¥é™å›åŸºç¡€æƒé‡ |
| ç­”å¯¹è¿ç»­ 3 æ¬¡ | -0.5 | è¯´æ˜å·²æŒæ¡ |
| 24å°æ—¶æœªå‡ºç° | +0.2 | é˜²æ­¢é—å¿˜ |
| è¶…æ—¶æœªç­” | +2.0 | è¯´æ˜å®Œå…¨ä¸ä¼š |

æƒé‡èŒƒå›´ï¼šæœ€ä½ 0.5ï¼ˆé˜²æ­¢å®Œå…¨ä¸å‡ºï¼‰ï¼Œæœ€é«˜ 5.0ï¼ˆé˜²æ­¢å…¨æ˜¯é”™é¢˜ï¼‰

#### 5.2.3 åŠ æƒé€‰é¢˜ç®—æ³•

```javascript
function weightedSelectQuestions(questions, count, module) {
    // 1. ä¸ºæ¯é“é¢˜æŸ¥è¯¢æƒé‡
    const weighted = questions.map(q => {
        const key = module + ':' + q.q;
        const record = App.questionWeights[key];
        return {
            question: q,
            weight: record ? record.weight : 1.0
        };
    });

    // 2. æŒ‰æƒé‡åŠ æƒéšæœºé‡‡æ ·ï¼ˆä¸æ”¾å›ï¼‰
    const selected = [];
    const pool = [...weighted];

    for (let i = 0; i < count && pool.length > 0; i++) {
        const totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
        let random = Math.random() * totalWeight;

        for (let j = 0; j < pool.length; j++) {
            random -= pool[j].weight;
            if (random <= 0) {
                selected.push(pool[j].question);
                pool.splice(j, 1);
                break;
            }
        }
    }

    return shuffle(selected); // æœ€ç»ˆé¡ºåºéšæœº
}
```

#### 5.2.4 é”™é¢˜è‡ªåŠ¨æ··å…¥

åœ¨æˆ˜æ–—æ¨¡å¼ä¸­ï¼Œé™¤äº†ä»å½“å‰æ¨¡å—é€‰é¢˜å¤–ï¼Œè‡ªåŠ¨æ··å…¥é”™é¢˜æœ¬ä¸­åŒæ¨¡å—çš„é”™é¢˜ï¼š

```javascript
// startBattle ä¸­ï¼š
const wrongQuestions = App.wrongBook
    .filter(w => w.module === battle.module)  // éœ€è¦åœ¨é”™é¢˜è®°å½•ä¸­å¢åŠ  module å­—æ®µ
    .map(w => ({ q: w.q, a: w.a, _fromWrongBook: true }));

// æ¯ 5 é“æ­£å¸¸é¢˜ç©¿æ’ 1 é“é”™é¢˜
const mixedQuestions = interlaceWrongQuestions(mainQuestions, wrongQuestions, 5);
```

#### 5.2.5 æƒé‡æŒä¹…åŒ–

æƒé‡æ•°æ®å­˜å…¥ localStorageï¼ˆæŒ‰ç”¨æˆ·ï¼‰ï¼š

```javascript
// key: questionWeights_{userId}
// value: JSON å¯¹è±¡ï¼Œçº¦ 5-15KBï¼ˆå–å†³äºåšè¿‡å¤šå°‘é¢˜ï¼‰
```

æ›´æ–°æ—¶æœºï¼š
- ç­”å¯¹/ç­”é”™æ—¶ç«‹å³æ›´æ–°å¯¹åº”é¢˜ç›®çš„æƒé‡
- é¡µé¢åŠ è½½æ—¶ä» localStorage è¯»å–
- saveProgress() æ—¶åŒæ­¥ä¿å­˜

#### 5.2.6 é”™é¢˜è®°å½•å¢å¼º

å½“å‰é”™é¢˜è®°å½•ç¼ºå°‘æ¨¡å—ä¿¡æ¯ï¼Œéœ€è¦åœ¨è®°å½•æ—¶è¡¥å……ï¼š

```javascript
// é”™é¢˜è®°å½•æ–°å¢ module å­—æ®µ
const wrongItem = {
    q: question.q,
    a: question.a,
    yourAnswer: userAnswer,
    timestamp: Date.now(),
    module: App.currentModule,           // æ–°å¢
    monsterEmoji: ...,
    monsterName: ...
};
```

### 5.3 å®ç°è¦ç‚¹

#### éœ€è¦æ–°å¢çš„æ–‡ä»¶

| æ–‡ä»¶ | å†…å®¹ | è¡Œæ•°ä¼°ç®— |
|------|------|----------|
| `js/question-engine.js` | åŠ æƒé€‰é¢˜ç®—æ³•ã€æƒé‡ç®¡ç†ã€é”™é¢˜æ··å…¥é€»è¾‘ | ~250è¡Œ |

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `practice.js` | `startPractice`: ä½¿ç”¨ `weightedSelectQuestions()` æ›¿æ¢çº¯éšæœº |
| `battle-combat.js` | `startBattle`: ä½¿ç”¨åŠ æƒé€‰é¢˜ + é”™é¢˜æ··å…¥; `handleCorrectAnswer/handleWrongAnswer`: æ›´æ–°æƒé‡ |
| `daily.js` | `initDailyChallenge`: ä½¿ç”¨åŠ æƒé€‰é¢˜ |
| `core.js` | App æ–°å¢ `questionWeights` å­—æ®µ |
| `practice.js`/`battle-combat.js`/`daily.js` | é”™é¢˜è®°å½•è¡¥å…… `module` å­—æ®µ |

---

## å…­ã€å®æ–½è®¡åˆ’

### Phase 1ï¼šbugä¿®å¤ï¼ˆP0ï¼‰â€” æœ€å…ˆåš

1. `battle-combat.js` initStage æ¸…ç©ºæ—§é¢˜ç›® + éšè—ç­”é¢˜åŒº
2. `battle-combat.js` showBattleQuestion åŠ é˜²é‡å…¥é”
3. `battle-combat.js` showStageTransition é®ç½©å»¶é•¿åˆ° 1500ms
4. æµ‹è¯•ï¼šè¿ç»­æ‰“ 3 å…³æ€ªç‰©ï¼Œç¡®è®¤æ— é—ªç°

### Phase 2ï¼šæ”»å‡»åŠ¨ç”»å‡çº§ï¼ˆP0ï¼‰

1. `battle-combat.js` handleCorrectAnswer æ¥å…¥ executeComboAttack å›è°ƒé“¾
2. `battle-arena.js` heroAttackAnimation å¢åŠ æ­¦å™¨ä¸¾èµ·+æŒ¥å‡»é˜¶æ®µ
3. `battle-arena.js` enemyAttackAnimation å¢åŠ è“„åŠ›é˜¶æ®µ
4. `battle-combat.js` åˆ é™¤æ—§ fireWeaponï¼Œæ‰€æœ‰è·¯å¾„èµ° fireWeaponHorizontal
5. `style.css` æ–°å¢ weapon-raise, weapon-swing, enemy-charge åŠ¨ç”»
6. `index.html` åˆ é™¤æ—§ #weapon-area
7. æµ‹è¯•ï¼šç­”å¯¹/ç­”é”™å„ç§è¿å‡»é˜¶æ®µçš„æ”»å‡»åŠ¨ç”»

### Phase 3ï¼šæˆ˜æ–—å€’è®¡æ—¶ï¼ˆP1ï¼‰

1. `index.html` battle-question-card å†…æ·»åŠ  timer-bar HTML
2. `style.css` å€’è®¡æ—¶æ¡æ ·å¼ï¼ˆæ¸å˜è‰²ã€é—ªçƒï¼‰
3. `battle-combat.js` startBattleTimer, handleTimeoutAnswer
4. `monster-behavior.js` dodge æ”¹ä¸ºåŸºäº inDangerZone
5. æµ‹è¯•ï¼šå„éš¾åº¦å€’è®¡æ—¶ã€è¶…æ—¶å¤„ç†ã€å±é™©åŒºé—ªé¿

### Phase 4ï¼šæ™ºèƒ½å‡ºé¢˜ç³»ç»Ÿï¼ˆP1ï¼‰

1. æ–°å»º `question-engine.js`
2. `core.js` å¢åŠ  questionWeights å­—æ®µ
3. `practice.js` / `battle-combat.js` / `daily.js` æ¥å…¥åŠ æƒé€‰é¢˜
4. é”™é¢˜è®°å½•å¢åŠ  module å­—æ®µ
5. `index.html` å¢åŠ  script æ ‡ç­¾
6. æµ‹è¯•ï¼šæ•…æ„ç­”é”™å‡ é“é¢˜ï¼ŒéªŒè¯åç»­å‡ºç°é¢‘ç‡æé«˜

### Phase 5ï¼šè¿å‡»æ”»å‡»é›†æˆï¼ˆP2ï¼‰

1. `handleCorrectAnswer` æ›¿æ¢ fireWeapon ä¸º executeComboAttack
2. è°ƒæ•´å„æ”»å‡»æ–¹æ³•æ—¶åºï¼ˆnormal â‰¤ 0.8sï¼Œultimate â‰¤ 1.5sï¼‰
3. æµ‹è¯•ï¼šä» combo 0 æ‰“åˆ° combo 20ï¼ŒéªŒè¯ 5 é˜¶æ®µæ”»å‡»æ¼”å‡º

---

## ä¸ƒã€æ–‡ä»¶å˜æ›´æ€»è§ˆ

| æ–‡ä»¶ | æ”¹åŠ¨ç¨‹åº¦ | è¯´æ˜ |
|------|----------|------|
| `js/battle-combat.js` | **å¤§æ”¹** | æ”»å‡»æµç¨‹é‡æ„ã€å€’è®¡æ—¶ã€é˜²é‡å…¥é”ã€åŠ æƒé€‰é¢˜æ¥å…¥ |
| `js/battle-arena.js` | **å¤§æ”¹** | æ­¦å™¨ä¸¾èµ·/æŒ¥å‡»åŠ¨ç”»ã€æ€ªç‰©è“„åŠ›åŠ¨ç”»ã€æŠ•å°„ç‰©æ‹–å°¾ |
| `js/hero-system.js` | **ä¸­æ”¹** | executeComboAttack æ¥å…¥ä¿®æ­£ã€æ—¶åºå¾®è°ƒ |
| `js/monster-behavior.js` | **å°æ”¹** | dodge æ”¹ä¸º inDangerZone åˆ¤å®š |
| `js/question-engine.js` | **æ–°å¢** | åŠ æƒé€‰é¢˜ç³»ç»Ÿï¼ˆ~250è¡Œï¼‰ |
| `js/practice.js` | **ä¸­æ”¹** | åŠ æƒé€‰é¢˜ã€é”™é¢˜ module å­—æ®µ |
| `js/daily.js` | **å°æ”¹** | åŠ æƒé€‰é¢˜ã€é”™é¢˜ module å­—æ®µ |
| `js/core.js` | **å°æ”¹** | questionWeights å­—æ®µ |
| `css/style.css` | **ä¸­æ”¹** | æ–°åŠ¨ç”»ã€å€’è®¡æ—¶æ¡æ ·å¼ |
| `index.html` | **å°æ”¹** | timer-bar HTMLã€åˆ é™¤ weapon-areaã€script æ ‡ç­¾ |

æ–°å¢ä»£ç é‡ä¼°ç®—ï¼š~500 è¡Œ
ä¿®æ”¹ä»£ç é‡ä¼°ç®—ï¼š~300 è¡Œ

---

## å…«ã€é£é™©ç‚¹ä¸åº”å¯¹

| é£é™© | åº”å¯¹ç­–ç•¥ |
|------|----------|
| æ”»å‡»åŠ¨ç”»æ—¶åºå˜åŒ–å½±å“ dealDamage é€»è¾‘ | å…¨éƒ¨ç”¨å›è°ƒé©±åŠ¨ï¼Œä¸ç¡¬ç¼–ç  setTimeout å»¶è¿Ÿ |
| executeComboAttack åœ¨ heroEmoji ä¸å­˜åœ¨æ—¶åŒæ­¥å›è°ƒ | ä¿æŒ fallback é€»è¾‘ï¼ŒDOM ä¸å­˜åœ¨æ—¶ç«‹å³ callback |
| è¿å‡»é«˜é˜¶åŠ¨ç”»ï¼ˆcharged/ultimateï¼‰å¤ªé•¿å½±å“èŠ‚å¥ | è®¾ä¸Šé™ï¼šnormal 0.8s, ultimate 1.5sï¼Œè¶…è¿‡å¼ºåˆ¶å›è°ƒ |
| åŠ æƒé€‰é¢˜å¯¼è‡´ localStorage è†¨èƒ€ | åªå­˜åšè¿‡çš„é¢˜ï¼ˆéå…¨é‡ï¼‰ï¼Œå®šæœŸæ¸…ç†90å¤©å‰è®°å½• |
| å€’è®¡æ—¶æ¡åœ¨ iPad ä¸Šå½±å“å¸§ç‡ | åªç”¨ CSS width transitionï¼Œä¸ç”¨ JS é€å¸§æ›´æ–° |
| Hard 2ç§’å¤ªçŸ­å¯¼è‡´å¤æ‚é¢˜ï¼ˆåˆ†æ•°/å°æ•°ï¼‰ä¸å¯èƒ½ç­”å¯¹ | æˆ˜æ–—æ¨¡å¼å‡ºé¢˜å·²æŒ‰éš¾åº¦ç­›é€‰ï¼ŒHard å‡ºçš„éƒ½æ˜¯éœ€è¦ç§’ç­”çš„ç†Ÿç»ƒé¢˜ |
| å€’è®¡æ—¶è®©æ¸¸æˆå˜å¾—ç„¦è™‘ä¸å¥½ç© | Easy 5ç§’è¶³å¤Ÿå‹å¥½ï¼›å€’è®¡æ—¶æ˜¯è®­ç»ƒå·¥å…·ä¸æ˜¯æƒ©ç½š |
| é”™é¢˜æœ¬æ²¡æœ‰ module å­—æ®µï¼ˆæ—§æ•°æ®å…¼å®¹ï¼‰ | ç¼ºå°‘ module æ—¶ä¸å‚ä¸æ··å…¥ï¼Œä¸æŠ¥é”™ |

---

## ä¹ã€éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯
- [ ] ä¸»è§’æ”»å‡»ï¼šç­”å¯¹åçœ‹åˆ°"ä¸¾æ­¦å™¨â†’æŒ¥å‡»â†’æŠ•å°„â†’å‘½ä¸­"å®Œæ•´æµç¨‹
- [ ] æ€ªç‰©æ”»å‡»ï¼šç­”é”™åçœ‹åˆ°"è“„åŠ›â†’å†²åˆºâ†’æŠ•å°„â†’å—å‡»"å®Œæ•´æµç¨‹
- [ ] è¿å‡» 0/3/5/10/15 å„é˜¶æ®µæ”»å‡»åŠ¨ç”»ä¸åŒ
- [ ] æˆ˜æ–—å€’è®¡æ—¶æ¡æ­£ç¡®æ˜¾ç¤ºï¼Œé¢œè‰²æ¸å˜
- [ ] è¶…æ—¶è‡ªåŠ¨åˆ¤é”™ï¼Œè§¦å‘æ€ªç‰©æ”»å‡»
- [ ] å±é™©åŒºå†…ç­”å¯¹ï¼Œæ€ªç‰©æ¦‚ç‡é—ªé¿
- [ ] éå±é™©åŒºç­”å¯¹ï¼Œæ€ªç‰©ä¸é—ªé¿
- [ ] è¿ç»­ 5 å…³æ— é¢˜ç›®é—ªç°
- [ ] æ•…æ„ç­”é”™ 3 é“åŒä¸€é¢˜ï¼ŒéªŒè¯åç»­å‡ºç°é¢‘ç‡æ˜æ˜¾æé«˜
- [ ] é”™é¢˜æ··å…¥æˆ˜æ–—æ¨¡å¼ï¼Œæ¯çº¦ 5 é¢˜ç©¿æ’ 1 é“é”™é¢˜
- [ ] ç»ƒä¹ æ¨¡å¼/æ¯æ—¥æŒ‘æˆ˜æ¨¡å¼åŒæ ·ä½¿ç”¨åŠ æƒé€‰é¢˜

### ä½“éªŒéªŒè¯
- [ ] æ”»å‡»åŠ¨ç”»èŠ‚å¥æ„Ÿå¥½ï¼Œä¸æ‹–æ²“
- [ ] Easy 5ç§’èŠ‚å¥æ„Ÿå¥½ï¼ŒHard 2ç§’ç´§å¼ ä½†ä¸ç„¦èº
- [ ] iPad Safari æµç•…æ— å¡é¡¿
- [ ] é”™é¢˜é¢‘ç‡æé«˜ä½†ä¸è¿‡åº¦ï¼ˆä¸ä¼š 10 é¢˜é‡Œ 8 é“æ˜¯é”™é¢˜ï¼‰

---

## åã€é™„å½•ï¼šæŠ€æœ¯å‘ç°å¤‡å¿˜

### A. ä¸¤å¥—æ”»å‡»ç³»ç»Ÿçš„å†å²åŸå› 

v14.0ï¼ˆå•æ–‡ä»¶æ—¶ä»£ï¼‰åªæœ‰å‚ç›´ `fireWeapon()`ã€‚v15.0 å¼•å…¥ç¬¬ä¸‰äººç§°èˆå°æ—¶æ–°å¢äº†æ°´å¹³ `fireWeaponHorizontal()`ï¼Œä½† `handleCorrectAnswer` çš„ä¸»è·¯å¾„æ²¡æœ‰è¿ç§»ï¼Œä»è°ƒç”¨æ—§ç‰ˆã€‚v16.0 åˆ›å»ºäº† `hero-system.js` çš„å®Œæ•´è¿å‡»æ”»å‡»ç³»ç»Ÿï¼Œä½†ä¹Ÿæœªæ¥å…¥ä¸»è·¯å¾„ã€‚v16.2 éœ€è¦ç»Ÿä¸€åºŸå¼ƒæ—§ç³»ç»Ÿï¼Œå…¨é¢åˆ‡æ¢åˆ°æ–°ç³»ç»Ÿã€‚

### B. showBattleQuestion çš„ 10 ä¸ªè°ƒç”¨ç‚¹

```
battle-combat.js:517  â€” initStage â†’ enemyEnterAnimation callback
battle-combat.js:790  â€” dodge â†’ executeDodge callback
battle-combat.js:1191 â€” dealDamage â†’ hpBehavior â†’ turnBehavior callback
battle-combat.js:1195 â€” dealDamage â†’ hpBehavior â†’ no turnBehavior
battle-combat.js:1204 â€” dealDamage â†’ turnBehavior callback
battle-combat.js:1208 â€” dealDamage â†’ normal (no behavior)
battle-combat.js:1258 â€” monsterAttack â†’ shield block
battle-combat.js:1296 â€” monsterAttack â†’ revive
battle-combat.js:1302 â€” monsterAttack â†’ survive
tower-mode.js:294,297 â€” tower floor question display
```

æ‰€æœ‰è°ƒç”¨ç‚¹éƒ½éœ€ç¡®ä¿ä¸é˜²é‡å…¥é”å…¼å®¹ã€‚

### C. questionWeights æ•°æ®ç»“æ„ç¤ºä¾‹

```json
{
  "xiaojiujiu:3Ã—7": { "w": 2.5, "wc": 1, "lw": 1707600000, "lc": null },
  "multiply:25Ã—4": { "w": 1.0, "wc": 0, "lw": null, "lc": 1707650000 },
  "fraction:1/3+1/3": { "w": 4.0, "wc": 3, "lw": 1707700000, "lc": null }
}
```

ä½¿ç”¨ç¼©å†™ key èŠ‚çœå­˜å‚¨ç©ºé—´ï¼šw=weight, wc=wrongCount, lw=lastWrong, lc=lastCorrectã€‚
