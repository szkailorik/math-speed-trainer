# v17.1 战斗场景背景系统 PRD

## 背景

v17.0 的背景系统只是换了渐变色+浮动emoji粒子，视觉上仍然单调。小朋友需要的是真正有**场景感**的战斗背景——不同属性的怪物出现在不同的环境中，像RPG游戏里那样有前景、中景、远景的层次感。

## 核心目标

> 让每一场战斗都像进入了一个新世界，小朋友一眼就能感受到"这个怪物来自哪里"。

## 设计原则

1. **纯CSS实现**：不依赖图片文件，全部用CSS渐变+伪元素+clip-path+box-shadow绘制场景，保持PWA轻量
2. **分层场景**：每个背景由 4 层组成（天空层 → 远景层 → 中景层 → 地面层），营造纵深感
3. **环境动效**：每种场景有独特的环境动画（飘雪、下雨、飘叶、火星、闪电等）
4. **怪物聚光**：怪物脚下根据属性显示光圈/魔法阵，突出怪物本身

---

## 场景架构

### HTML 结构（在 `.battle-arena` 内部添加）

```html
<div class="battle-arena">
    <!-- 新增：场景背景层 -->
    <div class="scene-layer scene-sky"></div>
    <div class="scene-layer scene-far"></div>
    <div class="scene-layer scene-mid"></div>
    <div class="scene-layer scene-effects"></div>

    <!-- 已有元素 -->
    <div class="arena-ground"></div>
    <div class="hero-side">...</div>
    <div class="attack-zone"></div>
    <div class="enemy-side">...</div>
    ...
</div>
```

### 4层场景说明

| 层 | CSS class | z-index | 作用 | 示例 |
|----|-----------|---------|------|------|
| 天空层 | `.scene-sky` | 0 | 渐变天空+天体（太阳/月亮/星星） | 火系→暗红天空+岩浆云；冰系→极光天空 |
| 远景层 | `.scene-far` | 1 | 远处剪影（山脉/城堡/森林轮廓） | 龙系→火山剪影；水系→远处海浪 |
| 中景层 | `.scene-mid` | 2 | 中距离元素（树/岩石/建筑柱子） | 暗系→墓碑剪影；妖精→蘑菇+花朵 |
| 特效层 | `.scene-effects` | 3 | 环境粒子动画（CSS生成） | 冰系→飘雪；火系→飞升火星；雷系→闪电 |

角色层（hero-side, enemy-side）保持 z-index: 10+，始终在场景之上。

---

## 24种属性场景设计

### 火系 (fire)
- **天空**：暗红→橙色渐变，顶部有暗红云层
- **远景**：火山剪影（clip-path三角形），山顶发红光
- **中景**：左右各一根岩柱剪影，底部有熔岩流光
- **地面**：暗棕色带橙色裂缝纹理（用 repeating-linear-gradient 模拟）
- **特效**：10-15个上升的火星粒子（橙/红小圆点），随机起始位置
- **怪物光圈**：橙红色脉冲光环

### 水系 (water)
- **天空**：深蓝→蓝绿渐变，底部有白色水雾
- **远景**：波浪线轮廓（clip-path wave），层叠2-3层不同透明度
- **中景**：左右珊瑚/岩石剪影
- **地面**：深蓝带波纹动画（用 repeating-linear-gradient + animation 模拟水面）
- **特效**：气泡粒子从底部缓慢上升
- **怪物光圈**：蓝色水波纹扩散

### 冰系 (ice)
- **天空**：暗蓝→白蓝渐变，顶部有极光色带（绿紫渐变条，水平摆动）
- **远景**：冰山剪影（clip-path锯齿山形），半透明蓝白
- **中景**：冰柱从顶部垂下（clip-path三角形倒挂）
- **地面**：浅蓝冰面，带反光光泽（linear-gradient 模拟冰面反射）
- **特效**：雪花粒子从顶部飘落（❄ CSS绘制的小十字或用 box-shadow 点阵）
- **怪物光圈**：冰蓝色冻结光环

### 雷/电系 (thunder/electric)
- **天空**：暗紫→近黑渐变，有暗色积雨云（clip-path圆弧）
- **远景**：城市天际线剪影（clip-path阶梯状矩形）
- **中景**：左右避雷针/电塔剪影
- **地面**：深灰色带偶尔的电弧光泽
- **特效**：随机闪电（细白线条，flash动画，0.1s出现后消失，3-5s间隔随机触发）
- **怪物光圈**：黄色电弧光环

### 草系 (grass)
- **天空**：深绿→墨绿渐变，有月亮（box-shadow圆）
- **远景**：连绵山丘轮廓（clip-path波浪）
- **中景**：左右大树剪影（clip-path树形），有些垂下的藤蔓
- **地面**：深绿→棕绿，有草丛尖角纹理（repeating-linear-gradient锯齿）
- **特效**：飘落的树叶粒子（绿色小方块旋转飘落）
- **怪物光圈**：绿色自然光环

### 暗系 (dark)
- **天空**：纯黑→极暗紫，几乎看不到
- **远景**：哥特城堡剪影（clip-path尖塔矩形组合）
- **中景**：枯树+墓碑剪影
- **地面**：极暗色，有紫色裂缝纹理
- **特效**：暗色雾气从底部缓慢上升，偶尔有幽灵般的光点
- **怪物光圈**：暗紫色暗能量旋转

### 鬼/灵系 (ghost/spirit)
- **天空**：暗紫蓝渐变，有大月亮（淡黄色圆+光晕）
- **远景**：鬼屋/废墟剪影
- **中景**：歪斜的栅栏+灯笼剪影
- **地面**：暗紫色，有薄雾漂浮
- **特效**：鬼火粒子（蓝绿色小光点，忽明忽暗漂浮）
- **怪物光圈**：幽蓝色灵魂光环

### 龙系 (dragon)
- **天空**：深紫→暗金渐变，有星空（box-shadow繁星点）
- **远景**：巨大火山+龙巢悬崖剪影
- **中景**：龙爪痕石柱+碎骨散落
- **地面**：暗紫色岩石，有金色纹路
- **特效**：火焰粒子+偶尔的龙息热浪（半透明橙色条快速掠过）
- **怪物光圈**：紫金色龙魂光环

### 妖精系 (fairy)
- **天空**：暗粉→淡紫渐变，有繁星
- **远景**：魔法森林轮廓，树冠圆润
- **中景**：大蘑菇+花朵剪影（左右各1-2个）
- **地面**：暗粉色，有花瓣散落纹理
- **特效**：亮粉色星光粒子缓慢漂浮
- **怪物光圈**：粉紫色星光旋转

### 毒系 (poison)
- **天空**：暗绿→暗紫渐变，有毒雾云层
- **远景**：沼泽枯木剪影
- **中景**：冒泡的毒池（clip-path不规则形+气泡动画）
- **地面**：暗绿色，有紫色毒液纹理
- **特效**：绿色气泡从底部上升+紫色毒雾
- **怪物光圈**：绿紫色毒气旋转

### 钢系 (steel)
- **天空**：暗灰→银灰渐变
- **远景**：工厂/堡垒剪影（矩形+烟囱）
- **中景**：齿轮+钢梁剪影
- **地面**：金属灰色，有铆钉纹理（repeating-radial-gradient 圆点阵列）
- **特效**：偶尔的火花粒子
- **怪物光圈**：银色金属光环

### 岩石/大地系 (rock/earth/ground)
- **天空**：暗棕→土黄渐变
- **远景**：层叠的悬崖台地剪影
- **中景**：大岩石+石柱剪影
- **地面**：棕色岩石纹理，有裂缝
- **特效**：偶尔从上方落下的碎石粒子
- **怪物光圈**：土黄色岩石光环

### 格斗系 (fighting)
- **天空**：暗红→橙渐变
- **远景**：竞技场台阶/圆形看台剪影
- **中景**：柱子+火炬剪影（火炬有火焰闪烁）
- **地面**：石板地面纹理
- **特效**：热浪/能量波纹
- **怪物光圈**：红色战斗光环

### 风/飞行系 (wind/flying)
- **天空**：暗蓝→青色渐变，有流云
- **远景**：浮空岛剪影（下方有垂落的瀑布线条）
- **中景**：高耸的石柱
- **地面**：浅色岩石+云雾缭绕
- **特效**：快速横移的风线条+飘动的云片
- **怪物光圈**：青色气流光环

### 光系 (light)
- **天空**：暗金→白金渐变，有神圣光芒放射线
- **远景**：神殿/塔楼剪影
- **中景**：光柱从天而降（半透明白金色竖条）
- **地面**：白金色大理石纹理
- **特效**：金色光尘粒子缓慢飘落
- **怪物光圈**：金色神圣光环

### 超能系 (psychic)
- **天空**：暗粉→暗紫渐变，有扭曲的空间感
- **远景**：漂浮的碎石/方块（旋转动画）
- **中景**：水晶柱剪影
- **地面**：深紫色带粉色纹路
- **特效**：扭曲光线效果（用CSS filter: hue-rotate动画）
- **怪物光圈**：粉紫色念力波纹

### 恶魔系 (demon)
- **天空**：血红→近黑渐变
- **远景**：地狱之门/尖塔剪影
- **中景**：锁链+尖刺石柱
- **地面**：暗红色，有熔岩裂缝
- **特效**：红色火焰+黑色烟雾粒子
- **怪物光圈**：血红色邪恶光环

### 野兽系 (beast)
- **天空**：暗橙→深棕渐变，有低月
- **远景**：非洲大草原树木（平顶金合欢树剪影）
- **中景**：灌木+岩石
- **地面**：土黄色草地纹理
- **特效**：尘土飞扬粒子
- **怪物光圈**：棕色野性光环

### 古代系 (ancient)
- **天空**：深灰→暗金渐变
- **远景**：金字塔/神殿废墟剪影
- **中景**：断裂的石柱+石碑
- **地面**：沙色+石板纹理
- **特效**：沙尘飘落+神秘符文光点
- **怪物光圈**：金色古代法阵

### 生物系 (creature)
- **天空**：深绿→暗蓝渐变
- **远景**：巨型蘑菇森林剪影
- **中景**：藤蔓+奇异植物
- **地面**：苔绿色
- **特效**：荧光孢子粒子
- **怪物光圈**：绿色生命光环

### 巫师系 (wizard)
- **天空**：深蓝紫渐变+繁星
- **远景**：魔法塔/尖顶城堡剪影
- **中景**：浮空书本+魔法阵
- **地面**：深蓝石板+符文纹理
- **特效**：蓝色魔法粒子旋转上升
- **怪物光圈**：蓝色魔法阵旋转

### 虫系 (bug)
- **天空**：暗黄绿渐变
- **远景**：巨型蜂巢/蚁穴剪影
- **中景**：大叶植物+蜘蛛网
- **地面**：暗绿色泥土
- **特效**：萤火虫光点
- **怪物光圈**：黄绿色虫茧光环

### 普通系 (normal)
- **天空**：深灰蓝渐变
- **远景**：平原小山丘
- **中景**：简单的栅栏+路灯
- **地面**：灰色石板路
- **特效**：少量星光
- **怪物光圈**：白色普通光环

---

## 怪物聚光系统

每个怪物脚下显示一个**属性光圈**，强化怪物的存在感：

```html
<!-- 在 .enemy-side 内部添加 -->
<div class="monster-aura" id="monster-aura"></div>
```

光圈效果：
- 椭圆形（怪物脚下），颜色随属性变化
- 持续脉冲动画（scale + opacity 循环）
- Boss 怪物光圈更大更亮
- 特殊状态变化：狂暴时光圈变红闪烁，恐惧时光圈缩小

---

## CSS绘制技巧规范

### 远景剪影用 clip-path
```css
/* 示例：火山剪影 */
.scene-far.fire-scene::before {
    clip-path: polygon(
        0% 100%, 15% 100%, 25% 40%, 35% 45%,
        45% 20%, 55% 25%, 65% 50%, 75% 100%, 100% 100%
    );
    background: rgba(20, 5, 0, 0.9);
}
```

### 环境粒子用 CSS @keyframes + 多个 box-shadow
```css
/* 示例：雪花 - 用一个元素的 box-shadow 画多个雪花点 */
.snow-particles::after {
    content: '';
    width: 3px; height: 3px;
    border-radius: 50%;
    box-shadow:
        20px 0 #fff, 60px 20px #fff, 100px -10px #fff,
        150px 30px #fff, 200px 10px #fff, 250px -20px #fff;
    animation: snow-fall 8s linear infinite;
}
```

### 天体用 radial-gradient + box-shadow
```css
/* 示例：月亮 */
.scene-sky.ghost-scene::after {
    content: '';
    width: 30px; height: 30px;
    border-radius: 50%;
    background: radial-gradient(circle, #fffde0 0%, #ffd700 100%);
    box-shadow: 0 0 20px 10px rgba(255, 253, 200, 0.15);
    position: absolute;
    top: 15%; right: 20%;
}
```

### 闪电用多段 clip-path + flash 动画
```css
.lightning-bolt {
    clip-path: polygon(45% 0%, 55% 0%, 52% 35%, 60% 35%, 48% 70%, 56% 70%, 42% 100%);
    background: rgba(255, 255, 200, 0.9);
    animation: lightning-flash 4s infinite;
}
```

---

## 实施步骤

### Phase 1: 场景层DOM + 基础框架 (~30min)

1. **index.html**: 在 `.battle-arena` 内添加4个 scene-layer div
2. **battle-arena.js**: `applyMonsterTheme()` 改为设置场景层的 CSS class（如 `fire-scene`）
3. **style.css**: 场景层基础CSS（position/z-index/pointer-events）

### Phase 2: 12个核心场景CSS绘制 (~3h)

优先实现出现频率最高的12种属性场景：
1. fire（火系）
2. water（水系）
3. ice（冰系）
4. thunder（雷系）
5. grass（草系）
6. dark（暗系）
7. ghost（鬼系）
8. dragon（龙系）
9. fairy（妖精系）
10. poison（毒系）
11. rock/earth（岩石系）
12. psychic（超能系）

每个场景包含：天空渐变 + 远景clip-path剪影 + 中景剪影 + 环境粒子动画

### Phase 3: 剩余12个场景 (~2h)

实现剩余属性场景：
steel, fighting, wind/flying, light, demon, beast, ancient, creature, wizard, bug, spirit, normal

### Phase 4: 怪物光圈系统 (~1h)

1. 在 `.enemy-side` 添加 `.monster-aura` div
2. 24种属性对应不同颜色/效果的光圈
3. Boss光圈放大+增强
4. 状态响应（狂暴→红色闪烁）

### Phase 5: 场景切换动画 (~30min)

1. 新怪物进场时场景淡入过渡（opacity 0→1，0.5s）
2. Boss 登场增加场景震动效果
3. 怪物死亡时场景短暂闪亮

### Phase 6: 性能优化 + 测试 (~30min)

1. 减少不必要的重排（will-change, transform 优先）
2. 低端设备检测：如果帧率<30fps，自动减少粒子数
3. 所有场景在6种模块×3种难度下测试

---

## 文件变更清单

| 文件 | 改动 |
|------|------|
| `index.html` | `.battle-arena` 内添加4个 scene-layer + monster-aura |
| `js/battle-arena.js` | 重写 `applyMonsterTheme()`，管理场景层class切换和粒子生成 |
| `css/style.css` | **大量新增**：24种场景的天空/远景/中景/特效CSS，怪物光圈CSS |
| `css/scenes.css` | **新建**：独立的场景CSS文件，避免style.css过大（~800-1000行） |

## 验证清单

- [ ] 火系怪物 → 看到火山+火星飞溅
- [ ] 水系怪物 → 看到海浪+气泡上升
- [ ] 冰系怪物 → 看到冰山+雪花飘落
- [ ] 雷系怪物 → 看到闪电闪烁
- [ ] 换怪时场景平滑过渡，无闪烁
- [ ] 怪物脚下有属性光圈
- [ ] Boss怪物光圈更大更亮
- [ ] 场景不遮挡题目和答案按钮
- [ ] 手机上流畅运行（>30fps）
